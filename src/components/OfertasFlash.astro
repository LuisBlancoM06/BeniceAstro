---
// Componente de Ofertas Flash
import { supabase } from '../lib/supabase';

// Obtener productos en oferta
const { data: ofertasProducts } = await supabase
  .from('products')
  .select('*')
  .eq('on_sale', true)
  .limit(6);

// Verificar si las ofertas están activas (desde site_settings)
const { data: settings } = await supabase
  .from('site_settings')
  .select('value')
  .eq('key', 'ofertas_flash_active')
  .single();

const ofertasActive = settings?.value === 'true';
const hasOfertas = ofertasProducts && ofertasProducts.length > 0;

// Solo mostrar si hay ofertas Y están activas
const showSection = ofertasActive && hasOfertas;
---

{showSection && (
  <section class="py-10 bg-gradient-to-br from-purple-800 via-purple-700 to-purple-900 relative overflow-hidden">
    <!-- Efectos de fondo premium -->
    <div class="absolute inset-0">
      <div class="absolute top-0 left-1/4 w-64 h-64 bg-orange-500/10 rounded-full blur-3xl"></div>
      <div class="absolute bottom-0 right-1/4 w-80 h-80 bg-purple-400/10 rounded-full blur-3xl"></div>
      <div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-96 h-96 bg-orange-500/5 rounded-full blur-3xl"></div>
    </div>

    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 relative z-10">
      <!-- Header premium -->
      <div class="text-center mb-8">
        <div class="inline-flex items-center gap-2 bg-white/10 backdrop-blur-md border border-white/10 px-5 py-2 rounded-full mb-4">
          <svg class="w-4 h-4 text-orange-400 animate-pulse" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M12.395 2.553a1 1 0 00-1.45-.385c-.345.23-.614.558-.822.88-.214.33-.403.713-.57 1.116-.334.804-.614 1.768-.84 2.734a31.365 31.365 0 00-.613 3.58 2.64 2.64 0 01-.945-1.067c-.328-.68-.398-1.534-.398-2.654A1 1 0 005.05 6.05 6.981 6.981 0 003 11a7 7 0 1011.95-4.95c-.592-.591-.98-.985-1.348-1.467-.363-.476-.724-1.063-1.207-2.03zM12.12 15.12A3 3 0 017 13s.879.5 2.5.5c0-1 .5-4 1.25-4.5.5 1 .786 1.293 1.371 1.879A2.99 2.99 0 0113 13a2.99 2.99 0 01-.879 2.121z" clip-rule="evenodd"/></svg>
          <span class="text-white font-bold text-sm tracking-wider uppercase">Ofertas Flash</span>
          <svg class="w-4 h-4 text-orange-400 animate-pulse" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M11.3 1.046A1 1 0 0112 2v5h4a1 1 0 01.82 1.573l-7 10A1 1 0 018 18v-5H4a1 1 0 01-.82-1.573l7-10a1 1 0 011.12-.38z" clip-rule="evenodd"/></svg>
        </div>
        <h2 class="text-2xl md:text-4xl font-extrabold text-white mb-2 leading-tight">
          Descuentos <span class="bg-gradient-to-r from-orange-400 to-orange-300 bg-clip-text text-transparent">Increíbles</span>
        </h2>
        <p class="text-purple-200 text-sm md:text-base">Aprovecha antes de que se agoten</p>
        
        <!-- Countdown premium -->
        <div class="flex justify-center gap-3 mt-5" id="countdown-container">
          <div class="bg-white/10 backdrop-blur-md rounded-xl px-4 py-2.5 text-center min-w-[60px] border border-white/10">
            <span id="countdown-hours" class="text-2xl font-extrabold text-white block leading-none">00</span>
            <p class="text-[10px] text-purple-200 mt-1 uppercase tracking-wider">Horas</p>
          </div>
          <div class="flex items-center text-white/40 font-bold text-xl -mx-1">:</div>
          <div class="bg-white/10 backdrop-blur-md rounded-xl px-4 py-2.5 text-center min-w-[60px] border border-white/10">
            <span id="countdown-minutes" class="text-2xl font-extrabold text-white block leading-none">00</span>
            <p class="text-[10px] text-purple-200 mt-1 uppercase tracking-wider">Minutos</p>
          </div>
          <div class="flex items-center text-white/40 font-bold text-xl -mx-1">:</div>
          <div class="bg-white/10 backdrop-blur-md rounded-xl px-4 py-2.5 text-center min-w-[60px] border border-white/10">
            <span id="countdown-seconds" class="text-2xl font-extrabold text-white block leading-none">00</span>
            <p class="text-[10px] text-purple-200 mt-1 uppercase tracking-wider">Segundos</p>
          </div>
        </div>
      </div>

      <!-- Carrusel de productos premium -->
      <div class="relative">
        <div id="ofertas-carousel" class="flex gap-5 overflow-x-auto snap-x snap-mandatory pb-4 scrollbar-hide px-1">
          {ofertasProducts?.map((product: any) => {
            const discount = product.sale_price 
              ? Math.round((1 - product.sale_price / product.price) * 100)
              : 0;
            
            return (
              <div class="flex-shrink-0 w-52 snap-center">
                <div class="bg-white rounded-2xl shadow-xl overflow-hidden transform hover:scale-[1.03] transition-all duration-300 group border border-white/20">
                  <div class="relative">
                    <div class="absolute top-2.5 left-2.5 z-10">
                      <span class="bg-red-500 text-white text-xs font-bold px-2.5 py-1 rounded-lg shadow-lg shadow-red-500/30">
                        -{discount}%
                      </span>
                    </div>
                    <div class="aspect-square bg-gradient-to-br from-gray-50 to-gray-100 p-3 overflow-hidden">
                      <img 
                        src={product.image_url || ''} 
                        alt={product.name}
                        class="w-full h-full object-contain group-hover:scale-110 transition-transform duration-500"
                        loading="lazy"
                      />
                    </div>
                  </div>

                  <div class="p-4">
                    <h3 class="font-bold text-gray-800 text-sm mb-2 line-clamp-2 min-h-[40px] leading-tight">
                      {product.name}
                    </h3>
                    
                    <div class="flex items-baseline gap-1.5 mb-3">
                      <span class="text-xl font-extrabold text-purple-700">
                        {product.sale_price?.toFixed(2)}€
                      </span>
                      <span class="text-xs text-gray-400 line-through">
                        {product.price?.toFixed(2)}€
                      </span>
                    </div>

                    <a 
                      href={`/producto/${product.slug || product.id}`}
                      class="block w-full text-center py-2.5 bg-gradient-to-r from-purple-700 to-purple-600 text-white text-sm font-bold rounded-xl hover:from-orange-500 hover:to-orange-600 transition-all duration-300 shadow-sm"
                    >
                      ¡Lo quiero!
                    </a>
                  </div>
                </div>
              </div>
            );
          })}
        </div>

        <!-- Controles -->
        <button id="prev-oferta" class="absolute left-0 top-1/2 -translate-y-1/2 -translate-x-3 bg-white/90 hover:bg-white shadow-xl rounded-full p-2.5 z-10 hidden lg:flex items-center justify-center transition-all hover:scale-110">
          <svg class="w-5 h-5 text-gray-700" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
          </svg>
        </button>
        <button id="next-oferta" class="absolute right-0 top-1/2 -translate-y-1/2 translate-x-3 bg-white/90 hover:bg-white shadow-xl rounded-full p-2.5 z-10 hidden lg:flex items-center justify-center transition-all hover:scale-110">
          <svg class="w-5 h-5 text-gray-700" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
          </svg>
        </button>
      </div>

      <!-- CTA premium -->
      <div class="text-center mt-6">
        <a 
          href="/productos?ofertas=true" 
          class="group inline-flex items-center gap-2 bg-white text-purple-700 font-bold text-sm px-7 py-3 rounded-full hover:bg-orange-50 transition-all shadow-xl shadow-black/10"
        >
          Ver todas las ofertas
          <svg class="w-5 h-5 group-hover:translate-x-1 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 8l4 4m0 0l-4 4m4-4H3"></path>
          </svg>
        </a>
      </div>
    </div>
  </section>
)}

<style>
  .scrollbar-hide::-webkit-scrollbar {
    display: none;
  }
  .scrollbar-hide {
    -ms-overflow-style: none;
    scrollbar-width: none;
  }
  .line-clamp-2 {
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }
</style>

<script>
  // Countdown timer - resets cada 24 horas desde medianoche
  function updateCountdown() {
    const now = new Date();
    const tomorrow = new Date(now);
    tomorrow.setDate(tomorrow.getDate() + 1);
    tomorrow.setHours(0, 0, 0, 0);
    
    const diff = tomorrow.getTime() - now.getTime();
    
    const hours = Math.floor(diff / (1000 * 60 * 60));
    const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
    const seconds = Math.floor((diff % (1000 * 60)) / 1000);
    
    const hoursEl = document.getElementById('countdown-hours');
    const minutesEl = document.getElementById('countdown-minutes');
    const secondsEl = document.getElementById('countdown-seconds');
    
    if (hoursEl) hoursEl.textContent = hours.toString().padStart(2, '0');
    if (minutesEl) minutesEl.textContent = minutes.toString().padStart(2, '0');
    if (secondsEl) secondsEl.textContent = seconds.toString().padStart(2, '0');
  }

  // Actualizar cada segundo
  updateCountdown();
  setInterval(updateCountdown, 1000);

  // Controles del carrusel
  const carousel = document.getElementById('ofertas-carousel');
  const prevBtn = document.getElementById('prev-oferta');
  const nextBtn = document.getElementById('next-oferta');

  prevBtn?.addEventListener('click', () => {
    carousel?.scrollBy({ left: -300, behavior: 'smooth' });
  });

  nextBtn?.addEventListener('click', () => {
    carousel?.scrollBy({ left: 300, behavior: 'smooth' });
  });
</script>
