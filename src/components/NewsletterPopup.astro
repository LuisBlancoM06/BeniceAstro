---
// Este componente se incluirá en el Layout
---

<!-- Newsletter Popup Modal -->
<div id="newsletter-popup" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
  <div class="bg-white rounded-2xl max-w-md w-full overflow-hidden shadow-2xl transform transition-all" id="popup-content">
    <!-- Botón cerrar -->
    <button id="close-popup" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600 z-10">
      <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
      </svg>
    </button>

    <!-- Contenido inicial: Formulario -->
    <div id="popup-form-container">
      <!-- Header con imagen -->
      <div class="bg-gradient-to-r from-purple-600 to-orange-500 px-6 py-8 text-center relative">
        <div class="w-16 h-16 mx-auto mb-2 bg-white/20 rounded-full flex items-center justify-center">
          <svg class="w-10 h-10 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"></path></svg>
        </div>
        <h2 class="text-2xl font-bold text-white">Unete a la familia Venice</h2>
        <p class="text-white/90 mt-1">Y obtén un regalo especial</p>
      </div>

      <!-- Formulario -->
      <div class="px-6 py-8">
        <div class="text-center mb-6">
          <div class="inline-flex items-center justify-center bg-purple-100 text-purple-800 px-4 py-2 rounded-full font-bold text-lg">
            10% de DESCUENTO
          </div>
          <p class="text-gray-600 mt-3">
            Suscríbete a nuestra newsletter y recibe un código de descuento exclusivo para tu primera compra.
          </p>
        </div>

        <form id="newsletter-popup-form" class="space-y-4">
          <div>
            <input 
              type="email" 
              id="popup-email" 
              required
              placeholder="Tu email"
              class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-yellow-400 focus:border-transparent"
            />
          </div>
          <button 
            type="submit" 
            class="w-full bg-purple-600 hover:bg-orange-500 text-white font-bold py-3 px-6 rounded-lg transition-colors flex items-center justify-center gap-2"
          >
            <span>Obtener mi código</span>
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 5l7 7m0 0l-7 7m7-7H3"></path>
            </svg>
          </button>
        </form>

        <div id="popup-error" class="hidden mt-4 p-3 bg-red-100 text-red-700 rounded-lg text-sm"></div>

        <p class="text-xs text-gray-500 text-center mt-4">
          Al suscribirte, aceptas recibir emails promocionales. Puedes darte de baja cuando quieras.
        </p>
      </div>
    </div>

    <!-- Contenido éxito: Código de descuento -->
    <div id="popup-success-container" class="hidden">
      <div class="bg-gradient-to-r from-purple-600 to-purple-500 px-6 py-8 text-center">
        <div class="w-16 h-16 mx-auto mb-2 bg-white/20 rounded-full flex items-center justify-center">
          <svg class="w-10 h-10 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>
        </div>
        <h2 class="text-2xl font-bold text-white">Bienvenido/a</h2>
        <p class="text-white/90 mt-1">Aquí tienes tu código de descuento</p>
      </div>

      <div class="px-6 py-8 text-center">
        <p class="text-gray-600 mb-4">Usa este código en tu próxima compra:</p>
        
        <div class="bg-gray-100 border-2 border-dashed border-purple-500 rounded-lg p-4 mb-4">
          <p class="text-2xl font-mono font-bold text-purple-600" id="popup-promo-code">XXXXXX</p>
        </div>

        <button 
          id="copy-code-btn"
          class="text-purple-600 hover:text-purple-700 font-medium flex items-center justify-center gap-2 mx-auto mb-6"
        >
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m0 0h2a2 2 0 012 2v3m2 4H10m0 0l3-3m-3 3l3 3"></path>
          </svg>
          <span>Copiar código</span>
        </button>

        <div class="bg-purple-50 rounded-lg p-4 text-sm text-purple-800">
          <p><strong>Tip:</strong> Este código te da un 10% de descuento en tu primera compra. No lo pierdas.</p>
        </div>

        <button 
          id="start-shopping-btn"
          class="w-full mt-6 bg-purple-600 hover:bg-orange-500 text-white font-bold py-3 px-6 rounded-lg transition-colors"
        >
          Empezar a comprar
        </button>
      </div>
    </div>
  </div>
</div>

<style>
  #newsletter-popup {
    animation: fadeIn 0.3s ease-out;
  }
  
  #popup-content {
    animation: slideUp 0.3s ease-out;
  }
  
  @keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
  }
  
  @keyframes slideUp {
    from { 
      opacity: 0;
      transform: translateY(20px);
    }
    to { 
      opacity: 1;
      transform: translateY(0);
    }
  }
</style>

<script>
  import { supabase } from '../lib/supabase';

  const popup = document.getElementById('newsletter-popup');
  const closeBtn = document.getElementById('close-popup');
  const form = document.getElementById('newsletter-popup-form') as HTMLFormElement;
  const formContainer = document.getElementById('popup-form-container');
  const successContainer = document.getElementById('popup-success-container');
  const promoCodeSpan = document.getElementById('popup-promo-code');
  const errorDiv = document.getElementById('popup-error');
  const copyBtn = document.getElementById('copy-code-btn');
  const startShoppingBtn = document.getElementById('start-shopping-btn');

  // Comprobar si debe mostrarse el popup
  function shouldShowPopup(): boolean {
    // No mostrar si ya se cerró/suscribió (cookie de 7 días)
    if (document.cookie.includes('newsletter_dismissed=true')) {
      return false;
    }
    // No mostrar si ya está suscrito (localStorage)
    if (localStorage.getItem('newsletter_subscribed')) {
      return false;
    }
    return true;
  }

  // Mostrar popup después de 5 segundos
  function initPopup() {
    if (shouldShowPopup()) {
      setTimeout(() => {
        popup?.classList.remove('hidden');
      }, 5000);
    }
  }

  // Cerrar popup y setear cookie
  function dismissPopup() {
    popup?.classList.add('hidden');
    // Cookie de 7 días
    const expires = new Date(Date.now() + 7 * 24 * 60 * 60 * 1000).toUTCString();
    document.cookie = `newsletter_dismissed=true; expires=${expires}; path=/`;
  }

  // Generar código promocional
  function generatePromoCode(): string {
    const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
    let code = 'WELCOME';
    for (let i = 0; i < 4; i++) {
      code += chars.charAt(Math.floor(Math.random() * chars.length));
    }
    return code;
  }

  // Event listeners
  closeBtn?.addEventListener('click', dismissPopup);

  popup?.addEventListener('click', (e) => {
    if (e.target === popup) {
      dismissPopup();
    }
  });

  form?.addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const emailInput = document.getElementById('popup-email') as HTMLInputElement;
    const email = emailInput.value.trim();

    if (!email) return;

    try {
      // Generar código
      const promoCode = generatePromoCode();

      // Guardar en Supabase
      const { error } = await supabase
        .from('newsletters')
        .insert([{ 
          email, 
          promo_code: promoCode,
          source: 'popup'
        }]);

      if (error) {
        if (error.code === '23505') { // Duplicate key
          errorDiv!.textContent = 'Este email ya está suscrito.';
          errorDiv?.classList.remove('hidden');
        } else {
          throw error;
        }
        return;
      }

      // Guardar en localStorage
      localStorage.setItem('newsletter_subscribed', 'true');
      localStorage.setItem('newsletter_promo_code', promoCode);

      // Mostrar éxito
      promoCodeSpan!.textContent = promoCode;
      formContainer?.classList.add('hidden');
      successContainer?.classList.remove('hidden');

    } catch (error: any) {
      console.error('Error al suscribir:', error);
      errorDiv!.textContent = 'Error al suscribirse. Inténtalo de nuevo.';
      errorDiv?.classList.remove('hidden');
    }
  });

  copyBtn?.addEventListener('click', () => {
    const code = promoCodeSpan?.textContent || '';
    navigator.clipboard.writeText(code);
    copyBtn.innerHTML = `
      <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
      </svg>
      <span>¡Copiado!</span>
    `;
    setTimeout(() => {
      copyBtn.innerHTML = `
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m0 0h2a2 2 0 012 2v3m2 4H10m0 0l3-3m-3 3l3 3"></path>
        </svg>
        <span>Copiar código</span>
      `;
    }, 2000);
  });

  startShoppingBtn?.addEventListener('click', () => {
    dismissPopup();
    window.location.href = '/productos';
  });

  // Inicializar
  initPopup();
</script>
