---
import Layout from '../layouts/Layout.astro';
import { supabase } from '../lib/supabase';
import ProductCard from '../components/ProductCard.tsx';

const { data: allProducts } = await supabase.from('products').select('*');
const products = allProducts || [];
---

<Layout title="Productos">
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <div class="grid grid-cols-1 lg:grid-cols-4 gap-8">

      <!-- Filtros -->
      <aside class="lg:col-span-1" aria-label="Filtros de productos">
        <div class="sticky top-4 bg-white rounded-2xl shadow-sm border border-gray-100 p-5">
          <h2 class="text-lg font-bold mb-4 flex items-center gap-2 text-gray-800">
            <svg class="w-5 h-5 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z"></path></svg>
            Filtros
          </h2>

          <!-- Especie -->
          <div class="filter-section border-t border-gray-100 pt-4" data-open="true">
            <button type="button" class="filter-toggle w-full flex items-center justify-between text-left font-semibold text-gray-700 mb-3 hover:text-purple-600 transition-colors">
              <span>Especie</span>
              <svg class="filter-arrow w-4 h-4 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
            </button>
            <div class="filter-content space-y-2">
              <label class="flex items-center gap-2.5 cursor-pointer group">
                <input type="checkbox" data-filter="animal_type" value="perro" class="filter-check w-4 h-4 rounded border-gray-300 text-purple-600 focus:ring-purple-500">
                <span class="text-sm text-gray-600 group-hover:text-gray-900">Perro</span>
              </label>
              <label class="flex items-center gap-2.5 cursor-pointer group">
                <input type="checkbox" data-filter="animal_type" value="gato" class="filter-check w-4 h-4 rounded border-gray-300 text-purple-600 focus:ring-purple-500">
                <span class="text-sm text-gray-600 group-hover:text-gray-900">Gato</span>
              </label>
              <label class="flex items-center gap-2.5 cursor-pointer group">
                <input type="checkbox" data-filter="animal_type" value="otros" class="filter-check w-4 h-4 rounded border-gray-300 text-purple-600 focus:ring-purple-500">
                <span class="text-sm text-gray-600 group-hover:text-gray-900">Otros animales</span>
              </label>
            </div>
          </div>

          <!-- Categoría -->
          <div class="filter-section border-t border-gray-100 pt-4 mt-4" data-open="false">
            <button type="button" class="filter-toggle w-full flex items-center justify-between text-left font-semibold text-gray-700 mb-3 hover:text-purple-600 transition-colors">
              <span>Categoría</span>
              <svg class="filter-arrow w-4 h-4 transition-transform -rotate-90" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
            </button>
            <div class="filter-content space-y-2 hidden">
              <label class="flex items-center gap-2.5 cursor-pointer group">
                <input type="checkbox" data-filter="category" value="alimentacion" class="filter-check w-4 h-4 rounded border-gray-300 text-purple-600 focus:ring-purple-500">
                <span class="text-sm text-gray-600 group-hover:text-gray-900">Alimentación</span>
              </label>
              <label class="flex items-center gap-2.5 cursor-pointer group">
                <input type="checkbox" data-filter="category" value="higiene" class="filter-check w-4 h-4 rounded border-gray-300 text-purple-600 focus:ring-purple-500">
                <span class="text-sm text-gray-600 group-hover:text-gray-900">Higiene</span>
              </label>
              <label class="flex items-center gap-2.5 cursor-pointer group">
                <input type="checkbox" data-filter="category" value="salud" class="filter-check w-4 h-4 rounded border-gray-300 text-purple-600 focus:ring-purple-500">
                <span class="text-sm text-gray-600 group-hover:text-gray-900">Salud</span>
              </label>
              <label class="flex items-center gap-2.5 cursor-pointer group">
                <input type="checkbox" data-filter="category" value="accesorios" class="filter-check w-4 h-4 rounded border-gray-300 text-purple-600 focus:ring-purple-500">
                <span class="text-sm text-gray-600 group-hover:text-gray-900">Accesorios</span>
              </label>
              <label class="flex items-center gap-2.5 cursor-pointer group">
                <input type="checkbox" data-filter="category" value="juguetes" class="filter-check w-4 h-4 rounded border-gray-300 text-purple-600 focus:ring-purple-500">
                <span class="text-sm text-gray-600 group-hover:text-gray-900">Juguetes</span>
              </label>
            </div>
          </div>

          <!-- Productos en Oferta -->
          <div class="filter-section border-t border-gray-100 pt-4 mt-4" data-open="false">
            <button type="button" class="filter-toggle w-full flex items-center justify-between text-left font-semibold text-gray-700 mb-3 hover:text-purple-600 transition-colors">
              <span>Productos en Oferta</span>
              <svg class="filter-arrow w-4 h-4 transition-transform -rotate-90" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
            </button>
            <div class="filter-content space-y-2 hidden">
              <label class="flex items-center gap-2.5 cursor-pointer group">
                <input type="checkbox" data-filter="on_sale" value="true" class="filter-check w-4 h-4 rounded border-gray-300 text-purple-600 focus:ring-purple-500">
                <span class="text-sm text-gray-600 group-hover:text-gray-900">Solo ofertas</span>
              </label>
            </div>
          </div>

          <!-- Precio -->
          <div class="filter-section border-t border-gray-100 pt-4 mt-4" data-open="false">
            <button type="button" class="filter-toggle w-full flex items-center justify-between text-left font-semibold text-gray-700 mb-3 hover:text-purple-600 transition-colors">
              <span>Precio</span>
              <svg class="filter-arrow w-4 h-4 transition-transform -rotate-90" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
            </button>
            <div class="filter-content space-y-2 hidden">
              <label class="flex items-center gap-2.5 cursor-pointer group">
                <input type="checkbox" data-filter="price_range" value="0-10" class="filter-check w-4 h-4 rounded border-gray-300 text-purple-600 focus:ring-purple-500">
                <span class="text-sm text-gray-600 group-hover:text-gray-900">Menos de 10€</span>
              </label>
              <label class="flex items-center gap-2.5 cursor-pointer group">
                <input type="checkbox" data-filter="price_range" value="10-25" class="filter-check w-4 h-4 rounded border-gray-300 text-purple-600 focus:ring-purple-500">
                <span class="text-sm text-gray-600 group-hover:text-gray-900">10€ - 25€</span>
              </label>
              <label class="flex items-center gap-2.5 cursor-pointer group">
                <input type="checkbox" data-filter="price_range" value="25-50" class="filter-check w-4 h-4 rounded border-gray-300 text-purple-600 focus:ring-purple-500">
                <span class="text-sm text-gray-600 group-hover:text-gray-900">25€ - 50€</span>
              </label>
              <label class="flex items-center gap-2.5 cursor-pointer group">
                <input type="checkbox" data-filter="price_range" value="50-999" class="filter-check w-4 h-4 rounded border-gray-300 text-purple-600 focus:ring-purple-500">
                <span class="text-sm text-gray-600 group-hover:text-gray-900">Más de 50€</span>
              </label>
            </div>
          </div>

          <!-- Edad -->
          <div class="filter-section border-t border-gray-100 pt-4 mt-4" data-open="false">
            <button type="button" class="filter-toggle w-full flex items-center justify-between text-left font-semibold text-gray-700 mb-3 hover:text-purple-600 transition-colors">
              <span>Edad</span>
              <svg class="filter-arrow w-4 h-4 transition-transform -rotate-90" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
            </button>
            <div class="filter-content space-y-2 hidden">
              <label class="flex items-center gap-2.5 cursor-pointer group">
                <input type="checkbox" data-filter="age_range" value="cachorro" class="filter-check w-4 h-4 rounded border-gray-300 text-purple-600 focus:ring-purple-500">
                <span class="text-sm text-gray-600 group-hover:text-gray-900">Cachorro / Joven</span>
              </label>
              <label class="flex items-center gap-2.5 cursor-pointer group">
                <input type="checkbox" data-filter="age_range" value="adulto" class="filter-check w-4 h-4 rounded border-gray-300 text-purple-600 focus:ring-purple-500">
                <span class="text-sm text-gray-600 group-hover:text-gray-900">Adulto</span>
              </label>
              <label class="flex items-center gap-2.5 cursor-pointer group">
                <input type="checkbox" data-filter="age_range" value="senior" class="filter-check w-4 h-4 rounded border-gray-300 text-purple-600 focus:ring-purple-500">
                <span class="text-sm text-gray-600 group-hover:text-gray-900">Senior</span>
              </label>
            </div>
          </div>

          <!-- Tamaño raza -->
          <div class="filter-section border-t border-gray-100 pt-4 mt-4" data-open="false">
            <button type="button" class="filter-toggle w-full flex items-center justify-between text-left font-semibold text-gray-700 mb-3 hover:text-purple-600 transition-colors">
              <span>Tamaño raza</span>
              <svg class="filter-arrow w-4 h-4 transition-transform -rotate-90" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
            </button>
            <div class="filter-content space-y-2 hidden">
              <label class="flex items-center gap-2.5 cursor-pointer group">
                <input type="checkbox" data-filter="size" value="mini" class="filter-check w-4 h-4 rounded border-gray-300 text-purple-600 focus:ring-purple-500">
                <span class="text-sm text-gray-600 group-hover:text-gray-900">Mini</span>
              </label>
              <label class="flex items-center gap-2.5 cursor-pointer group">
                <input type="checkbox" data-filter="size" value="mediano" class="filter-check w-4 h-4 rounded border-gray-300 text-purple-600 focus:ring-purple-500">
                <span class="text-sm text-gray-600 group-hover:text-gray-900">Mediano</span>
              </label>
              <label class="flex items-center gap-2.5 cursor-pointer group">
                <input type="checkbox" data-filter="size" value="grande" class="filter-check w-4 h-4 rounded border-gray-300 text-purple-600 focus:ring-purple-500">
                <span class="text-sm text-gray-600 group-hover:text-gray-900">Grande</span>
              </label>
            </div>
          </div>

          <!-- Limpiar filtros -->
          <button type="button" id="clear-filters" class="mt-5 w-full text-sm text-orange-500 hover:text-orange-700 font-medium py-2.5 border border-orange-200 rounded-xl hover:bg-orange-50 transition-all hidden">
            ✕ Limpiar filtros
          </button>
        </div>
      </aside>

      <!-- Grid de Productos -->
      <section class="lg:col-span-3" aria-label="Listado de productos">
        <div class="flex items-center justify-between mb-5">
          <p class="text-sm text-gray-500">
            <span id="result-count" class="text-orange-500 font-bold">{products.length}</span> Resultados
          </p>
          <div class="flex items-center gap-2">
            <span class="text-sm text-gray-500 hidden sm:inline">Ordenar por</span>
            <select id="sort-select" class="text-sm border border-gray-200 rounded-lg px-3 py-2 bg-white focus:ring-2 focus:ring-purple-500 focus:border-transparent cursor-pointer">
              <option value="default">Relevancia</option>
              <option value="price-asc">Precio: menor a mayor</option>
              <option value="price-desc">Precio: mayor a menor</option>
              <option value="name-asc">Nombre: A - Z</option>
              <option value="name-desc">Nombre: Z - A</option>
            </select>
          </div>
        </div>

        <div id="products-grid" class="grid grid-cols-2 md:grid-cols-3 xl:grid-cols-4 gap-4 stagger-children">
          {products.map((product: any) => {
            const price = product.sale_price && (product.on_sale === true || product.on_sale === 'true') 
              ? Number(product.sale_price) : Number(product.price);
            const isOnSale = product.on_sale === true || product.on_sale === 'true';
            return (
              <div 
                class="product-card animate-fade-in-up"
                data-animal={product.animal_type}
                data-category={product.category}
                data-size={product.size}
                data-age={product.age_range}
                data-onsale={String(isOnSale)}
                data-price={String(price)}
                data-name={product.name}
              >
                <ProductCard product={product} client:load />
              </div>
            );
          })}
        </div>

        <div id="no-results" class="text-center py-16 hidden">
          <div class="animate-fade-in">
          <svg class="w-20 h-20 mx-auto mb-4 text-gray-200" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
          </svg>
          <h3 class="text-xl font-semibold text-gray-700 mb-2">No hay productos con estos filtros</h3>
          <p class="text-sm text-gray-400 mb-4">Prueba cambiando o quitando filtros</p>
          <button type="button" onclick="document.getElementById('clear-filters')?.click()" class="text-purple-600 hover:text-purple-700 font-medium text-sm underline underline-offset-2">
            Limpiar todos los filtros
          </button>
          </div>
        </div>
      </section>
    </div>
  </div>

  <script>
    // Secciones colapsables
    document.querySelectorAll('.filter-toggle').forEach(btn => {
      btn.addEventListener('click', () => {
        const section = btn.closest('.filter-section')!;
        const content = section.querySelector('.filter-content')!;
        const arrow = section.querySelector('.filter-arrow')!;
        const isOpen = section.getAttribute('data-open') === 'true';
        if (isOpen) {
          content.classList.add('hidden');
          arrow.classList.add('-rotate-90');
          section.setAttribute('data-open', 'false');
        } else {
          content.classList.remove('hidden');
          arrow.classList.remove('-rotate-90');
          section.setAttribute('data-open', 'true');
        }
      });
    });

    function applyFilters() {
      const filters: Record<string, string[]> = {};
      document.querySelectorAll<HTMLInputElement>('.filter-check:checked').forEach(cb => {
        const key = cb.getAttribute('data-filter')!;
        if (!filters[key]) filters[key] = [];
        filters[key].push(cb.value);
      });

      const hasFilters = Object.keys(filters).length > 0;
      document.getElementById('clear-filters')?.classList.toggle('hidden', !hasFilters);

      const cards = document.querySelectorAll<HTMLElement>('#products-grid .product-card');
      let visible = 0;

      cards.forEach(card => {
        let show = true;

        for (const [key, values] of Object.entries(filters)) {
          if (key === 'animal_type') {
            if (!values.includes(card.dataset.animal || '')) show = false;
          } else if (key === 'category') {
            if (!values.includes(card.dataset.category || '')) show = false;
          } else if (key === 'size') {
            if (!values.includes(card.dataset.size || '')) show = false;
          } else if (key === 'age_range') {
            if (!values.includes(card.dataset.age || '')) show = false;
          } else if (key === 'on_sale') {
            if (card.dataset.onsale !== 'true') show = false;
          } else if (key === 'price_range') {
            const price = parseFloat(card.dataset.price || '0');
            const inRange = values.some(range => {
              const [min, max] = range.split('-').map(Number);
              return price >= min && price <= max;
            });
            if (!inRange) show = false;
          }
        }

        card.style.display = show ? '' : 'none';
        if (show) visible++;
      });

      document.getElementById('result-count')!.textContent = String(visible);
      document.getElementById('no-results')!.classList.toggle('hidden', visible > 0);
    }

    function applySorting() {
      const grid = document.getElementById('products-grid')!;
      const cards = Array.from(grid.querySelectorAll<HTMLElement>('.product-card'));
      const sortVal = (document.getElementById('sort-select') as HTMLSelectElement).value;

      cards.sort((a, b) => {
        switch (sortVal) {
          case 'price-asc':
            return parseFloat(a.dataset.price || '0') - parseFloat(b.dataset.price || '0');
          case 'price-desc':
            return parseFloat(b.dataset.price || '0') - parseFloat(a.dataset.price || '0');
          case 'name-asc':
            return (a.dataset.name || '').localeCompare(b.dataset.name || '');
          case 'name-desc':
            return (b.dataset.name || '').localeCompare(a.dataset.name || '');
          default:
            return 0;
        }
      });

      cards.forEach(card => grid.appendChild(card));
      applyFilters();
    }

    // Función para marcar casillas según filtros activos
    function updateCheckboxesFromFilters() {
      const urlParams = new URLSearchParams(window.location.search);
      
      // Verificar si hay filtros en la URL
      if (urlParams.has('animal_type')) {
        const animalType = urlParams.get('animal_type');
        const checkbox = document.querySelector(`input[data-filter="animal_type"][value="${animalType}"]`) as HTMLInputElement;
        if (checkbox) {
          checkbox.checked = true;
        }
      }
      
      // Aplicar filtros después de marcar las casillas
      applyFilters();
    }

    // Filtrar al instante al cambiar checkbox
    document.querySelectorAll('.filter-check').forEach(cb => {
      cb.addEventListener('change', applyFilters);
    });

    // Ordenar
    document.getElementById('sort-select')?.addEventListener('change', applySorting);

    // Limpiar filtros
    document.getElementById('clear-filters')?.addEventListener('click', () => {
      document.querySelectorAll<HTMLInputElement>('.filter-check').forEach(cb => cb.checked = false);
      applyFilters();
    });

    // Inicializar filtros desde URL al cargar la página
    updateCheckboxesFromFilters();
  </script>
</Layout>
