---
import Layout from '../layouts/Layout.astro';
import { supabase } from '../lib/supabase';

// Obtener parámetros de búsqueda
const url = new URL(Astro.request.url);
const animalType = url.searchParams.get('tipo');
const size = url.searchParams.get('tamano');
const category = url.searchParams.get('categoria');
const ageRange = url.searchParams.get('edad');

// Construir consulta con filtros
let query = supabase.from('products').select('*');

if (animalType) query = query.eq('animal_type', animalType);
if (size) query = query.eq('size', size);
if (category) query = query.eq('category', category);
if (ageRange) query = query.eq('age_range', ageRange);

const { data: products } = await query;
---

<Layout title="Productos">
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <h1 class="text-4xl font-bold mb-8">Catálogo de Productos</h1>

    <div class="grid grid-cols-1 lg:grid-cols-4 gap-8">
      <!-- Filtros -->
      <div class="lg:col-span-1">
        <div class="card sticky top-4">
          <h2 class="text-xl font-bold mb-4">Filtros</h2>
          
          <form id="filter-form">
            <!-- Tipo de Animal -->
            <div class="mb-6">
              <h3 class="font-semibold mb-2">Tipo de Animal</h3>
              <label class="flex items-center mb-2">
                <input type="radio" name="tipo" value="" checked class="mr-2">
                Todos
              </label>
              <label class="flex items-center mb-2">
                <input type="radio" name="tipo" value="perro" class="mr-2">
                Perros
              </label>
              <label class="flex items-center mb-2">
                <input type="radio" name="tipo" value="gato" class="mr-2">
                Gatos
              </label>
              <label class="flex items-center mb-2">
                <input type="radio" name="tipo" value="otros" class="mr-2">
                Otros
              </label>
            </div>

            <!-- Tamaño -->
            <div class="mb-6">
              <h3 class="font-semibold mb-2">Tamaño</h3>
              <label class="flex items-center mb-2">
                <input type="radio" name="tamano" value="" checked class="mr-2">
                Todos
              </label>
              <label class="flex items-center mb-2">
                <input type="radio" name="tamano" value="mini" class="mr-2">
                Mini
              </label>
              <label class="flex items-center mb-2">
                <input type="radio" name="tamano" value="mediano" class="mr-2">
                Mediano
              </label>
              <label class="flex items-center mb-2">
                <input type="radio" name="tamano" value="grande" class="mr-2">
                Grande
              </label>
            </div>

            <!-- Categoría -->
            <div class="mb-6">
              <h3 class="font-semibold mb-2">Categoría</h3>
              <label class="flex items-center mb-2">
                <input type="radio" name="categoria" value="" checked class="mr-2">
                Todas
              </label>
              <label class="flex items-center mb-2">
                <input type="radio" name="categoria" value="alimentacion" class="mr-2">
                Alimentación
              </label>
              <label class="flex items-center mb-2">
                <input type="radio" name="categoria" value="higiene" class="mr-2">
                Higiene
              </label>
              <label class="flex items-center mb-2">
                <input type="radio" name="categoria" value="salud" class="mr-2">
                Salud
              </label>
              <label class="flex items-center mb-2">
                <input type="radio" name="categoria" value="accesorios" class="mr-2">
                Accesorios
              </label>
              <label class="flex items-center mb-2">
                <input type="radio" name="categoria" value="juguetes" class="mr-2">
                Juguetes
              </label>
            </div>

            <!-- Edad -->
            <div class="mb-6">
              <h3 class="font-semibold mb-2">Edad</h3>
              <label class="flex items-center mb-2">
                <input type="radio" name="edad" value="" checked class="mr-2">
                Todas
              </label>
              <label class="flex items-center mb-2">
                <input type="radio" name="edad" value="cachorro" class="mr-2">
                Cachorro/Joven
              </label>
              <label class="flex items-center mb-2">
                <input type="radio" name="edad" value="adulto" class="mr-2">
                Adulto
              </label>
              <label class="flex items-center mb-2">
                <input type="radio" name="edad" value="senior" class="mr-2">
                Senior
              </label>
            </div>

            <button type="button" id="apply-filters" class="btn btn-primary w-full">
              Aplicar Filtros
            </button>
          </form>
        </div>
      </div>

      <!-- Grid de Productos -->
      <div class="lg:col-span-3">
        <div class="mb-4 text-gray-600">
          {products && products.length > 0 ? `${products.length} productos encontrados` : 'No se encontraron productos'}
        </div>

        <div id="products-grid" class="grid grid-cols-2 md:grid-cols-3 xl:grid-cols-4 gap-4">
          {products && products.map((product) => (
            <div class="product-card" data-product={JSON.stringify(product)}>
              <!-- Renderizado por React -->
            </div>
          ))}
        </div>

        {(!products || products.length === 0) && (
          <div class="text-center py-16">
            <svg class="w-16 h-16 mx-auto mb-4 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4" />
            </svg>
            <h3 class="text-xl font-semibold text-gray-700 mb-2">No hay productos disponibles</h3>
            <p class="text-gray-500">Prueba con otros filtros</p>
          </div>
        )}
      </div>
    </div>
  </div>

  <!-- Script para renderizar ProductCards -->
  <script>
    import { createElement } from 'react';
    import { createRoot } from 'react-dom/client';
    import ProductCard from '../components/ProductCard.tsx';
    
    // Renderizar las tarjetas de producto con React
    document.addEventListener('DOMContentLoaded', () => {
      const productCards = document.querySelectorAll('.product-card');
      productCards.forEach((container) => {
        const productData = container.getAttribute('data-product');
        if (productData) {
          const product = JSON.parse(productData);
          const root = createRoot(container);
          root.render(createElement(ProductCard, { product, showQuickActions: true }));
        }
      });
    });

    // Aplicar filtros
    const form = document.getElementById('filter-form');
    const applyButton = document.getElementById('apply-filters');

    // Cargar valores de filtro desde URL
    const urlParams = new URLSearchParams(window.location.search);
    if (urlParams.get('tipo')) {
      const el = document.querySelector(`input[name="tipo"][value="${urlParams.get('tipo')}"]`) as HTMLInputElement;
      if (el) el.checked = true;
    }
    if (urlParams.get('tamano')) {
      const el = document.querySelector(`input[name="tamano"][value="${urlParams.get('tamano')}"]`) as HTMLInputElement;
      if (el) el.checked = true;
    }
    if (urlParams.get('categoria')) {
      const el = document.querySelector(`input[name="categoria"][value="${urlParams.get('categoria')}"]`) as HTMLInputElement;
      if (el) el.checked = true;
    }
    if (urlParams.get('edad')) {
      const el = document.querySelector(`input[name="edad"][value="${urlParams.get('edad')}"]`) as HTMLInputElement;
      if (el) el.checked = true;
    }

    applyButton?.addEventListener('click', () => {
      const formData = new FormData(form as HTMLFormElement);
      const params = new URLSearchParams();

      if (formData.get('tipo')) params.set('tipo', formData.get('tipo') as string);
      if (formData.get('tamano')) params.set('tamano', formData.get('tamano') as string);
      if (formData.get('categoria')) params.set('categoria', formData.get('categoria') as string);
      if (formData.get('edad')) params.set('edad', formData.get('edad') as string);

      window.location.href = `/productos?${params.toString()}`;
    });
  </script>
</Layout>
