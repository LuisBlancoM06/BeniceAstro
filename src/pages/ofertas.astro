---
import Layout from '../layouts/Layout.astro';
import { supabase } from '../lib/supabase';

// Obtener productos en oferta
const { data: products } = await supabase
  .from('products')
  .select('*')
  .eq('on_sale', true)
  .order('created_at', { ascending: false });

// Fecha límite para el countdown (ejemplo: 7 días desde ahora)
const endDate = new Date();
endDate.setDate(endDate.getDate() + 7);
---

<Layout title="Ofertas - Hasta 50% de descuento">
  <!-- Hero con countdown -->
  <section class="relative bg-gradient-to-r from-red-600 to-orange-500 text-white py-16 overflow-hidden">
    <div class="absolute inset-0">
      <div class="absolute inset-0 bg-black/30"></div>
      <!-- Confetti animado -->
      <div class="confetti-container"></div>
    </div>
    
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 relative">
      <div class="text-center">
        <span class="inline-block bg-orange-500 text-white px-4 py-1 rounded-full text-sm font-bold mb-4 animate-bounce">
          OFERTAS LIMITADAS
        </span>
        <h1 class="text-4xl md:text-6xl font-bold mb-4">Super Ofertas</h1>
        <p class="text-xl md:text-2xl opacity-90 mb-8">Hasta <span class="font-bold text-orange-300">50% de descuento</span> en productos seleccionados</p>
        
        <!-- Countdown -->
        <div class="flex justify-center gap-4 mb-8">
          <div class="bg-white/20 backdrop-blur rounded-xl p-4 min-w-[80px]">
            <span id="days" class="text-4xl font-bold block">00</span>
            <span class="text-sm opacity-80">Días</span>
          </div>
          <div class="bg-white/20 backdrop-blur rounded-xl p-4 min-w-[80px]">
            <span id="hours" class="text-4xl font-bold block">00</span>
            <span class="text-sm opacity-80">Horas</span>
          </div>
          <div class="bg-white/20 backdrop-blur rounded-xl p-4 min-w-[80px]">
            <span id="minutes" class="text-4xl font-bold block">00</span>
            <span class="text-sm opacity-80">Min</span>
          </div>
          <div class="bg-white/20 backdrop-blur rounded-xl p-4 min-w-[80px]">
            <span id="seconds" class="text-4xl font-bold block">00</span>
            <span class="text-sm opacity-80">Seg</span>
          </div>
        </div>

        <p class="text-lg">¡Date prisa! Las ofertas terminan pronto</p>
      </div>
    </div>
  </section>

  <!-- Beneficios -->
  <section class="bg-gray-900 text-white py-6">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="flex flex-wrap justify-center gap-8 text-center">
        <div class="flex items-center gap-2">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V2"></path></svg>
          <span>Envío gratis +49€</span>
        </div>
        <div class="flex items-center gap-2">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h10a8 8 0 018 8v2M3 10l6 6m-6-6l6-6"></path></svg>
          <span>Devolución 30 días</span>
        </div>
        <div class="flex items-center gap-2">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path></svg>
          <span>Pago 100% seguro</span>
        </div>
        <div class="flex items-center gap-2">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"></path></svg>
          <span>Atención 24/7</span>
        </div>
      </div>
    </div>
  </section>

  <!-- Categorías de ofertas -->
  <section class="py-12 bg-white">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="flex flex-wrap gap-4 justify-center">
        <button class="px-6 py-3 bg-orange-500 text-white rounded-full font-medium hover:bg-orange-600 transition-colors">
          Todas las ofertas
        </button>
        <button class="px-6 py-3 bg-gray-100 text-gray-700 rounded-full font-medium hover:bg-gray-200 transition-colors">
          Perros
        </button>
        <button class="px-6 py-3 bg-gray-100 text-gray-700 rounded-full font-medium hover:bg-gray-200 transition-colors">
          Gatos
        </button>
        <button class="px-6 py-3 bg-gray-100 text-gray-700 rounded-full font-medium hover:bg-gray-200 transition-colors">
          Alimentación
        </button>
        <button class="px-6 py-3 bg-gray-100 text-gray-700 rounded-full font-medium hover:bg-gray-200 transition-colors">
          Juguetes
        </button>
        <button class="px-6 py-3 bg-gray-100 text-gray-700 rounded-full font-medium hover:bg-gray-200 transition-colors">
          Salud
        </button>
      </div>
    </div>
  </section>

  <!-- Flash deals destacados -->
  <section class="py-12 bg-gradient-to-b from-yellow-50 to-white">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="flex items-center justify-between mb-8">
        <div class="flex items-center gap-3">
          <svg class="w-8 h-8 text-yellow-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg>
          <h2 class="text-2xl font-bold">Ofertas Flash</h2>
          <span class="bg-red-500 text-white text-xs px-2 py-1 rounded-full animate-pulse">EN VIVO</span>
        </div>
        <a href="#all-offers" class="text-orange-500 hover:underline font-medium">Ver todas →</a>
      </div>

      {products && products.length > 0 ? (
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">
          {products.slice(0, 4).map((product: any) => (
            <div class="product-card" data-product={JSON.stringify(product)}></div>
          ))}
        </div>
      ) : (
        <div class="text-center py-8 bg-white rounded-xl">
          <p class="text-gray-500">No hay ofertas flash activas en este momento</p>
        </div>
      )}
    </div>
  </section>

  <!-- Banner cupón -->
  <section class="py-8 bg-orange-500">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="flex flex-col md:flex-row items-center justify-between gap-4 text-white">
        <div>
          <h3 class="text-2xl font-bold">¿Primera compra?</h3>
          <p class="opacity-90">Usa el código <span class="font-mono bg-white/20 px-2 py-1 rounded">BIENVENIDO10</span> y obtén un 10% extra</p>
        </div>
        <button class="bg-white text-orange-500 px-6 py-3 rounded-lg font-bold hover:bg-gray-100 transition-colors">
          Copiar código
        </button>
      </div>
    </div>
  </section>

  <!-- Todas las ofertas -->
  <section id="all-offers" class="py-12">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <h2 class="text-2xl font-bold mb-8">Todas las ofertas ({products?.length || 0})</h2>
      
      {products && products.length > 0 ? (
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">
          {products.map((product: any) => (
            <div class="product-card" data-product={JSON.stringify(product)}></div>
          ))}
        </div>
      ) : (
        <div class="text-center py-16 bg-gray-50 rounded-xl">
          <svg class="w-16 h-16 mx-auto mb-4 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z"></path></svg>
          <h3 class="text-xl font-semibold text-gray-700 mb-2">No hay ofertas activas</h3>
          <p class="text-gray-500 mb-6">Vuelve pronto para descubrir nuevas promociones</p>
          <a href="/productos" class="inline-block bg-orange-500 text-white px-6 py-3 rounded-lg font-medium hover:bg-orange-600 transition-colors">
            Ver todos los productos
          </a>
        </div>
      )}
    </div>
  </section>

  <!-- Newsletter -->
  <section class="py-12 bg-purple-700">
    <div class="max-w-3xl mx-auto px-4 text-center text-white">
      <h2 class="text-3xl font-bold mb-4">¿No quieres perderte ninguna oferta?</h2>
      <p class="text-xl text-purple-200 mb-8">Suscríbete y recibe las mejores ofertas directamente en tu email</p>
      <form class="flex flex-col sm:flex-row gap-4 max-w-md mx-auto">
        <input 
          type="email" 
          placeholder="tu@email.com" 
          class="flex-1 px-4 py-3 rounded-lg text-gray-900 focus:ring-4 focus:ring-white/30"
        />
        <button type="submit" class="bg-orange-500 text-white px-6 py-3 rounded-lg font-bold hover:bg-orange-600 transition-colors">
          ¡Suscribirme!
        </button>
      </form>
    </div>
  </section>
</Layout>

<style>
  @keyframes confetti-fall {
    0% { transform: translateY(-100vh) rotate(0deg); opacity: 1; }
    100% { transform: translateY(100vh) rotate(720deg); opacity: 0; }
  }
  
  .confetti-container::before {
    content: '*';
    position: absolute;
    font-size: 2rem;
    color: #fbbf24;
    animation: confetti-fall 5s linear infinite;
    left: 10%;
  }
  
  .confetti-container::after {
    content: '*';
    position: absolute;
    font-size: 2rem;
    color: #f97316;
    animation: confetti-fall 4s linear infinite;
    animation-delay: 1s;
    right: 10%;
  }
</style>

<script define:vars={{ endDate: endDate.toISOString() }}>
  // Countdown timer
  function updateCountdown() {
    const end = new Date(endDate);
    const now = new Date();
    const diff = end - now;
    
    if (diff <= 0) {
      document.getElementById('days').textContent = '00';
      document.getElementById('hours').textContent = '00';
      document.getElementById('minutes').textContent = '00';
      document.getElementById('seconds').textContent = '00';
      return;
    }
    
    const days = Math.floor(diff / (1000 * 60 * 60 * 24));
    const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
    const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
    const seconds = Math.floor((diff % (1000 * 60)) / 1000);
    
    document.getElementById('days').textContent = days.toString().padStart(2, '0');
    document.getElementById('hours').textContent = hours.toString().padStart(2, '0');
    document.getElementById('minutes').textContent = minutes.toString().padStart(2, '0');
    document.getElementById('seconds').textContent = seconds.toString().padStart(2, '0');
  }
  
  updateCountdown();
  setInterval(updateCountdown, 1000);
</script>

<script>
  import { createElement } from 'react';
  import { createRoot } from 'react-dom/client';
  import ProductCard from '../components/ProductCard.tsx';
  
  document.addEventListener('DOMContentLoaded', () => {
    const productCards = document.querySelectorAll('.product-card');
    productCards.forEach((container) => {
      const productData = container.getAttribute('data-product');
      if (productData) {
        const product = JSON.parse(productData);
        const root = createRoot(container);
        root.render(createElement(ProductCard));
      }
    });
  });
</script>