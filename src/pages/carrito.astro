---
import Layout from '../layouts/Layout.astro';
---

<Layout title="Carrito de Compras">
  <div class="max-w-4xl mx-auto px-4 py-8">
    <h1 class="text-4xl font-bold mb-8">Carrito de Compras</h1>

    <div id="empty-cart" class="hidden text-center py-12">
      <div class="text-6xl mb-4">
        <svg class="w-24 h-24 mx-auto text-purple-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z"></path>
        </svg>
      </div>
      <p class="text-xl text-gray-600 mb-4">Tu carrito está vacío</p>
      <a href="/productos" class="btn btn-primary">
        Ver Productos
      </a>
    </div>

    <div id="cart-content">
      <div class="space-y-4 mb-8" id="cart-items"></div>

      <!-- Código Promocional -->
      <div class="card mb-8">
        <h3 class="font-bold mb-4">¿Tienes un código promocional?</h3>
        <div class="flex gap-2">
          <input
            type="text"
            id="promo-code-input"
            placeholder="Introduce tu código"
            class="input flex-1"
          />
          <button id="apply-promo" class="btn btn-secondary">
            Aplicar
          </button>
        </div>
        <div id="promo-message" class="mt-2 text-sm"></div>
      </div>

      <!-- Resumen -->
      <div class="card bg-gray-50">
        <h3 class="font-bold text-xl mb-4">Resumen del Pedido</h3>
        <div class="space-y-2 mb-4">
          <div class="flex justify-between">
            <span>Subtotal:</span>
            <span id="subtotal">0€</span>
          </div>
          <div id="discount-row" class="hidden flex justify-between text-green-600">
            <span>Descuento (<span id="discount-percent"></span>):</span>
            <span id="discount-amount">0€</span>
          </div>
          <div class="border-t pt-2 flex justify-between text-xl font-bold">
            <span>Total:</span>
            <span id="total">0€</span>
          </div>
        </div>
        <button id="checkout-btn" class="btn btn-primary w-full">
          Proceder al Pago
        </button>
      </div>
    </div>
  </div>

  <script>
    import { supabase } from '../lib/supabase';
    import { $cartItems, $cartSubtotal, $cartCount, updateQuantity, removeFromCart, clearCart } from '../stores/cart';

    // Sanitizar texto para evitar XSS
    function esc(s: any): string {
      const div = document.createElement('div');
      div.textContent = String(s ?? '');
      return div.innerHTML;
    }
    function escAttr(s: any): string {
      return String(s ?? '').replace(/&/g, '&amp;').replace(/"/g, '&quot;').replace(/'/g, '&#39;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
    }

    let appliedPromo: any = null;

    function renderCart() {
      const cart = $cartItems.get();
      const cartItemsEl = document.getElementById('cart-items');
      const emptyCart = document.getElementById('empty-cart');
      const cartContent = document.getElementById('cart-content');

      if (cart.length === 0) {
        emptyCart?.classList.remove('hidden');
        cartContent?.classList.add('hidden');
        return;
      }

      emptyCart?.classList.add('hidden');
      cartContent?.classList.remove('hidden');

      cartItemsEl!.innerHTML = cart.map((item) => {
        const imgSrc = item.image || '';
        const safeName = esc(item.name);
        const safeNameAttr = escAttr(item.name);
        const safeId = escAttr(item.id);
        const safeImgSrc = escAttr(imgSrc);
        const isPlaceholderImg = imgSrc.includes('placehold.co') || imgSrc.includes('via.placeholder') || !imgSrc;
        const imageHtml = isPlaceholderImg
          ? `<div class="w-24 h-24 rounded bg-gradient-to-br from-purple-400 to-pink-500 flex items-center justify-center"><span class="text-white/80 text-xs font-semibold text-center px-1">${safeName}</span></div>`
          : `<img src="${safeImgSrc}" alt="${safeNameAttr}" class="w-24 h-24 object-cover rounded" onerror="this.outerHTML='<div class=\\'w-24 h-24 rounded bg-gradient-to-br from-purple-400 to-pink-500 flex items-center justify-center\\'><span class=\\'text-white/80 text-xs font-semibold text-center px-1\\'>${safeNameAttr}</span></div>'">`;
        return `
        <div class="card flex items-center gap-4">
          ${imageHtml}
          <div class="flex-1">
            <h3 class="font-bold">${safeName}</h3>
            <p class="text-gray-600">${(item.salePrice || item.price).toFixed(2)}€</p>
          </div>
          <div class="flex items-center gap-2">
            <button class="btn bg-gray-200 text-gray-800 px-3 py-1" data-id="${item.id}" data-action="decrease">
              -
            </button>
            <span class="w-12 text-center">${item.quantity}</span>
            <button class="btn bg-gray-200 text-gray-800 px-3 py-1" data-id="${item.id}" data-action="increase">
              +
            </button>
          </div>
          <div class="font-bold">
            ${((item.salePrice || item.price) * item.quantity).toFixed(2)}€
          </div>
          <button class="btn btn-danger px-3 py-1" data-id="${item.id}" data-action="remove">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
          </button>
        </div>
      `}).join('');

      updateSummary();

      // Event listeners para botones
      document.querySelectorAll('[data-action]').forEach(btn => {
        btn.addEventListener('click', (e) => {
          const target = e.currentTarget as HTMLElement;
          const id = target.dataset.id;
          const action = target.dataset.action;
          if (!id || !action) return;
          
          handleCartAction(action, id);
        });
      });
    }

    function handleCartAction(action: string, id: string) {
      const cart = $cartItems.get();
      const item = cart.find(i => i.id === id);
      if (!item) return;
      
      switch (action) {
        case 'increase':
          updateQuantity(id, item.quantity + 1);
          break;
        case 'decrease':
          if (item.quantity > 1) {
            updateQuantity(id, item.quantity - 1);
          }
          break;
        case 'remove':
          removeFromCart(id);
          break;
      }
      
      renderCart();
    }

    function updateSummary() {
      const subtotal = $cartSubtotal.get();
      
      document.getElementById('subtotal')!.textContent = subtotal.toFixed(2) + '€';
      
      let total = subtotal;
      let discountAmount = 0;
      
      if (appliedPromo) {
        discountAmount = (subtotal * appliedPromo.discount_percentage) / 100;
        total = subtotal - discountAmount;
        
        document.getElementById('discount-row')?.classList.remove('hidden');
        document.getElementById('discount-percent')!.textContent = appliedPromo.discount_percentage + '%';
        document.getElementById('discount-amount')!.textContent = '-' + discountAmount.toFixed(2) + '€';
      } else {
        document.getElementById('discount-row')?.classList.add('hidden');
      }
      
      document.getElementById('total')!.textContent = total.toFixed(2) + '€';
    }

    // Aplicar código promocional
    document.getElementById('apply-promo')?.addEventListener('click', async () => {
      const input = document.getElementById('promo-code-input') as HTMLInputElement;
      const code = input.value.trim().toUpperCase();
      const message = document.getElementById('promo-message');

      if (!code) {
        message!.textContent = 'Introduce un código';
        message!.className = 'mt-2 text-sm text-red-600';
        return;
      }

      try {
        const { data, error } = await supabase
          .from('promo_codes')
          .select('*')
          .eq('code', code)
          .eq('active', true)
          .single();

        if (error || !data) {
          message!.textContent = 'Código inválido o expirado';
          message!.className = 'mt-2 text-sm text-red-600';
          appliedPromo = null;
        } else {
          // Verificar fecha de expiración
          if (data.expires_at && new Date(data.expires_at) < new Date()) {
            message!.textContent = 'El código ha expirado';
            message!.className = 'mt-2 text-sm text-red-600';
            appliedPromo = null;
          } else {
            message!.textContent = `¡Código aplicado! ${data.discount_percentage}% de descuento`;
            message!.className = 'mt-2 text-sm text-green-600';
            appliedPromo = data;
          }
        }

        updateSummary();
      } catch (error) {
        console.error('Error al verificar código:', error);
      }
    });

    // Proceder al pago
    document.getElementById('checkout-btn')?.addEventListener('click', async () => {
      const cart = $cartItems.get();
      if (cart.length === 0) {
        alert('El carrito está vacío');
        return;
      }

      // Redirigir al checkout con Stripe
      window.location.href = '/checkout';
    });

    // Inicializar
    renderCart();
  </script>
</Layout>
