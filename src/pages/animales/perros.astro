---
import Layout from '../../layouts/Layout.astro';
import { supabase } from '../../lib/supabase';

// Obtener productos de perros
const { data: products } = await supabase
  .from('products')
  .select('*')
  .eq('animal_type', 'perro')
  .order('created_at', { ascending: false });

// Categor√≠as espec√≠ficas para perros
const categories = [
  { id: 'alimentacion', name: 'Alimentaci√≥n', icon: 'üçñ', description: 'Piensos, h√∫medos y snacks' },
  { id: 'salud', name: 'Salud', icon: 'üíä', description: 'Antiparasitarios y vitaminas' },
  { id: 'accesorios', name: 'Accesorios', icon: 'üéÄ', description: 'Collares, correas y camas' },
  { id: 'juguetes', name: 'Juguetes', icon: 'üéæ', description: 'Pelotas, mordedores y m√°s' },
];

const sizes = [
  { id: 'mini', name: 'Mini/Toy', description: 'Hasta 5kg' },
  { id: 'mediano', name: 'Mediano', description: '5-25kg' },
  { id: 'grande', name: 'Grande', description: '+25kg' },
];

const ages = [
  { id: 'cachorro', name: 'Cachorro', description: '0-12 meses' },
  { id: 'adulto', name: 'Adulto', description: '1-7 a√±os' },
  { id: 'senior', name: 'Senior', description: '+7 a√±os' },
];
---

<Layout title="Productos para Perros">
  <!-- Hero Section -->
  <section class="relative bg-purple-700 text-white py-16">
    <div class="absolute inset-0 bg-black/10"></div>
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 relative">
      <nav class="text-sm mb-4 opacity-80">
        <a href="/" class="hover:underline">Inicio</a>
        <span class="mx-2">‚Ä∫</span>
        <span>Perros</span>
      </nav>
      <div class="flex items-center gap-4">
        <svg class="w-16 h-16" fill="currentColor" viewBox="0 0 24 24"><path d="M18 4c-1 0-2 .5-3 1-.5-1-1.5-2-3-2s-2.5 1-3 2c-1-.5-2-1-3-1-2.5 0-4 2-4 4 0 1.5.5 3 2 4v7c0 .5.5 1 1 1h2c.5 0 1-.5 1-1v-2h8v2c0 .5.5 1 1 1h2c.5 0 1-.5 1-1v-7c1.5-1 2-2.5 2-4 0-2-1.5-4-4-4z"/></svg>
        <div>
          <h1 class="text-4xl md:text-5xl font-bold mb-2">Todo para tu Perro</h1>
          <p class="text-xl opacity-90">Encuentra los mejores productos para el cuidado de tu mejor amigo</p>
        </div>
      </div>
      <div class="mt-8 flex flex-wrap gap-4">
        <div class="bg-white/20 backdrop-blur rounded-lg px-6 py-3">
          <span class="font-bold text-2xl">{products?.length || 0}</span>
          <span class="ml-2">Productos</span>
        </div>
        <div class="bg-white/20 backdrop-blur rounded-lg px-6 py-3">
          <svg class="w-8 h-8 inline-block" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V2"></path></svg>
          <span class="ml-2">Env√≠o gratis +49‚Ç¨</span>
        </div>
        <div class="bg-white/20 backdrop-blur rounded-lg px-6 py-3">
          <span class="font-bold text-2xl">24h</span>
          <span class="ml-2">Entrega r√°pida</span>
        </div>
      </div>
    </div>
  </section>

  <!-- Categor√≠as -->
  <section class="py-12 bg-gray-50">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <h2 class="text-2xl font-bold mb-6">Categor√≠as</h2>
      <div class="grid grid-cols-2 md:grid-cols-5 gap-4">
        {categories.map((cat) => (
          <a 
            href={`/animales/perros?categoria=${cat.id}`}
            class="bg-white rounded-xl p-6 text-center hover:shadow-lg transition-all hover:-translate-y-1 border border-gray-100 group"
          >
            <span class="text-4xl block mb-3 group-hover:scale-110 transition-transform">{cat.icon}</span>
            <h3 class="font-semibold text-gray-900">{cat.name}</h3>
            <p class="text-sm text-gray-500 mt-1">{cat.description}</p>
          </a>
        ))}
      </div>
    </div>
  </section>

  <!-- Filtros y Productos -->
  <section class="py-12">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="flex flex-col lg:flex-row gap-8">
        <!-- Sidebar Filtros -->
        <aside class="lg:w-64 flex-shrink-0">
          <div class="bg-white rounded-xl shadow-sm p-6 sticky top-24">
            <h3 class="font-bold text-lg mb-4 flex items-center gap-2">
              <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z" />
              </svg>
              Filtros
            </h3>

            <!-- Por tama√±o -->
            <div class="mb-6">
              <h4 class="font-medium text-gray-700 mb-3">Tama√±o del perro</h4>
              <div class="space-y-2">
                {sizes.map((size) => (
                  <label class="flex items-center gap-2 cursor-pointer group">
                    <input type="checkbox" name="size" value={size.id} class="rounded text-purple-600 focus:ring-purple-500" />
                    <span class="group-hover:text-purple-600 transition-colors">{size.name}</span>
                    <span class="text-xs text-gray-400">({size.description})</span>
                  </label>
                ))}
              </div>
            </div>

            <!-- Por edad -->
            <div class="mb-6">
              <h4 class="font-medium text-gray-700 mb-3">Edad</h4>
              <div class="space-y-2">
                {ages.map((age) => (
                  <label class="flex items-center gap-2 cursor-pointer group">
                    <input type="checkbox" name="age" value={age.id} class="rounded text-purple-600 focus:ring-purple-500" />
                    <span class="group-hover:text-purple-600 transition-colors">{age.name}</span>
                    <span class="text-xs text-gray-400">({age.description})</span>
                  </label>
                ))}
              </div>
            </div>

            <!-- Por precio -->
            <div class="mb-6">
              <h4 class="font-medium text-gray-700 mb-3">Precio</h4>
              <div class="space-y-2">
                <label class="flex items-center gap-2 cursor-pointer">
                  <input type="radio" name="price" value="0-20" class="text-purple-600 focus:ring-purple-500" />
                  <span>Hasta 20‚Ç¨</span>
                </label>
                <label class="flex items-center gap-2 cursor-pointer">
                  <input type="radio" name="price" value="20-50" class="text-purple-600 focus:ring-purple-500" />
                  <span>20‚Ç¨ - 50‚Ç¨</span>
                </label>
                <label class="flex items-center gap-2 cursor-pointer">
                  <input type="radio" name="price" value="50+" class="text-purple-600 focus:ring-purple-500" />
                  <span>M√°s de 50‚Ç¨</span>
                </label>
              </div>
            </div>

            <!-- Solo ofertas -->
            <div class="mb-6">
              <label class="flex items-center gap-2 cursor-pointer">
                <input type="checkbox" name="on_sale" class="rounded text-purple-600 focus:ring-purple-500" />
                <span class="font-medium">Solo ofertas</span>
                <span class="bg-red-100 text-red-600 text-xs px-2 py-0.5 rounded-full">HOT</span>
              </label>
            </div>

            <button class="w-full bg-purple-600 text-white py-2 rounded-lg hover:bg-purple-700 transition-colors">
              Aplicar filtros
            </button>
            <button class="w-full mt-2 text-gray-500 hover:text-gray-700 transition-colors text-sm">
              Limpiar filtros
            </button>
          </div>
        </aside>

        <!-- Grid de productos -->
        <div class="flex-1">
          <div class="flex justify-between items-center mb-6">
            <p class="text-gray-600">{products?.length || 0} productos encontrados</p>
            <select class="border border-gray-200 rounded-lg px-4 py-2 focus:ring-2 focus:ring-purple-500 focus:border-purple-500">
              <option>Ordenar por relevancia</option>
              <option>Precio: menor a mayor</option>
              <option>Precio: mayor a menor</option>
              <option>M√°s vendidos</option>
              <option>Novedades</option>
            </select>
          </div>

          <div id="products-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
            {products?.map((product: any) => (
              <div class="product-card" data-product={JSON.stringify(product)}>
                <!-- Renderizado por React -->
              </div>
            ))}
          </div>

          {(!products || products.length === 0) && (
            <div class="text-center py-16">
              <svg class="w-16 h-16 mx-auto mb-4 text-gray-300" fill="currentColor" viewBox="0 0 24 24"><path d="M18 4c-1 0-2 .5-3 1-.5-1-1.5-2-3-2s-2.5 1-3 2c-1-.5-2-1-3-1-2.5 0-4 2-4 4 0 1.5.5 3 2 4v7c0 .5.5 1 1 1h2c.5 0 1-.5 1-1v-2h8v2c0 .5.5 1 1 1h2c.5 0 1-.5 1-1v-7c1.5-1 2-2.5 2-4 0-2-1.5-4-4-4z"/></svg>
              <h3 class="text-xl font-semibold text-gray-700 mb-2">No hay productos disponibles</h3>
              <p class="text-gray-500">Pronto a√±adiremos m√°s productos para perros</p>
            </div>
          )}
        </div>
      </div>
    </div>
  </section>

  <!-- Secci√≥n de consejos -->
  <section class="py-12 bg-purple-50">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <h2 class="text-2xl font-bold mb-6">Consejos para tu perro</h2>
      <div class="grid md:grid-cols-3 gap-6">
        <article class="bg-white rounded-xl overflow-hidden shadow-sm hover:shadow-lg transition-all">
          <img src="https://via.placeholder.com/400x200/7e22ce/ffffff?text=Alimentacion" alt="Alimentaci√≥n" class="w-full h-48 object-cover" />
          <div class="p-6">
            <span class="text-purple-600 text-sm font-medium">Alimentaci√≥n</span>
            <h3 class="font-bold text-lg mt-2">¬øC√≥mo elegir el mejor pienso?</h3>
            <p class="text-gray-600 mt-2 text-sm">Descubre los factores clave para elegir la alimentaci√≥n perfecta...</p>
            <a href="/blog" class="text-purple-600 font-medium mt-4 inline-block hover:underline">
              Leer m√°s ‚Üí
            </a>
          </div>
        </article>
        <article class="bg-white rounded-xl overflow-hidden shadow-sm hover:shadow-lg transition-all">
          <img src="https://via.placeholder.com/400x200/f97316/ffffff?text=Higiene" alt="Higiene" class="w-full h-48 object-cover" />
          <div class="p-6">
            <span class="text-orange-500 text-sm font-medium">Higiene</span>
            <h3 class="font-bold text-lg mt-2">Ba√±o perfecto en casa</h3>
            <p class="text-gray-600 mt-2 text-sm">Gu√≠a completa para ba√±ar a tu perro como un profesional...</p>
            <a href="/blog" class="text-purple-600 font-medium mt-4 inline-block hover:underline">
              Leer m√°s ‚Üí
            </a>
          </div>
        </article>
        <article class="bg-white rounded-xl overflow-hidden shadow-sm hover:shadow-lg transition-all">
          <img src="https://via.placeholder.com/400x200/10b981/ffffff?text=Salud" alt="Salud" class="w-full h-48 object-cover" />
          <div class="p-6">
            <span class="text-green-600 text-sm font-medium">Salud</span>
            <h3 class="font-bold text-lg mt-2">Calendario de vacunas</h3>
            <p class="text-gray-600 mt-2 text-sm">Todo lo que necesitas saber sobre las vacunas de tu perro...</p>
            <a href="/blog" class="text-purple-600 font-medium mt-4 inline-block hover:underline">
              Leer m√°s ‚Üí
            </a>
          </div>
        </article>
      </div>
    </div>
  </section>
</Layout>

<script>
  import { createElement } from 'react';
  import { createRoot } from 'react-dom/client';
  import ProductCard from '../../components/ProductCard.tsx';
  
  // Renderizar las tarjetas de producto con React
  document.addEventListener('DOMContentLoaded', () => {
    const productCards = document.querySelectorAll('.product-card');
    const allProducts: any[] = [];
    const roots = new Map();

    productCards.forEach((container) => {
      const productData = container.getAttribute('data-product');
      if (productData) {
        const product = JSON.parse(productData);
        allProducts.push({ product, container });
        const root = createRoot(container);
        roots.set(container, root);
        root.render(createElement(ProductCard, { product }));
      }
    });

    // Filter logic
    const grid = document.getElementById('products-grid');
    const applyBtn = document.querySelector('button.bg-purple-600') as HTMLButtonElement;
    const clearBtn = applyBtn?.nextElementSibling as HTMLButtonElement;
    const sortSelect = document.querySelector('select') as HTMLSelectElement;
    const countText = document.querySelector('.flex-1 .text-gray-600') as HTMLElement;

    function getFilteredProducts() {
      const selectedSizes = Array.from(document.querySelectorAll('input[name="size"]:checked')).map((el) => (el as HTMLInputElement).value);
      const selectedAges = Array.from(document.querySelectorAll('input[name="age"]:checked')).map((el) => (el as HTMLInputElement).value);
      const selectedPrice = (document.querySelector('input[name="price"]:checked') as HTMLInputElement)?.value;
      const onSaleOnly = (document.querySelector('input[name="on_sale"]') as HTMLInputElement)?.checked;

      return allProducts.filter(({ product }) => {
        if (selectedSizes.length > 0 && !selectedSizes.includes(product.size)) return false;
        if (selectedAges.length > 0 && !selectedAges.includes(product.age_range)) return false;
        if (onSaleOnly && !product.on_sale) return false;
        if (selectedPrice) {
          const price = product.on_sale && product.sale_price ? product.sale_price : product.price;
          if (selectedPrice === '0-20' && price > 20) return false;
          if (selectedPrice === '20-50' && (price < 20 || price > 50)) return false;
          if (selectedPrice === '50+' && price < 50) return false;
        }
        return true;
      });
    }

    function renderFiltered() {
      const filtered = getFilteredProducts();
      
      // Sort
      const sortValue = sortSelect?.value || '';
      if (sortValue.includes('menor a mayor')) {
        filtered.sort((a, b) => (a.product.price) - (b.product.price));
      } else if (sortValue.includes('mayor a menor')) {
        filtered.sort((a, b) => (b.product.price) - (a.product.price));
      }

      // Hide all, show filtered
      allProducts.forEach(({ container }) => (container as HTMLElement).style.display = 'none');
      filtered.forEach(({ container }) => (container as HTMLElement).style.display = '');
      
      if (countText) countText.textContent = `${filtered.length} productos encontrados`;
    }

    applyBtn?.addEventListener('click', renderFiltered);
    sortSelect?.addEventListener('change', renderFiltered);
    
    clearBtn?.addEventListener('click', () => {
      document.querySelectorAll('input[name="size"]:checked, input[name="age"]:checked, input[name="price"]:checked, input[name="on_sale"]:checked').forEach((el) => {
        (el as HTMLInputElement).checked = false;
      });
      renderFiltered();
    });

    // Apply URL-based category filter
    const urlParams = new URLSearchParams(window.location.search);
    const categoryParam = urlParams.get('categoria');
    if (categoryParam) {
      allProducts.forEach(({ product, container }) => {
        if (product.category !== categoryParam) {
          (container as HTMLElement).style.display = 'none';
        }
      });
      const visible = allProducts.filter(({ product }) => product.category === categoryParam);
      if (countText) countText.textContent = `${visible.length} productos encontrados`;
    }
  });
</script>

