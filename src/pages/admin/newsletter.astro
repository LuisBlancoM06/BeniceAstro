---
export const prerender = false;
import AdminLayout from '../../layouts/AdminLayout.astro';
import { createServerClient } from '../../lib/supabase';

const supabase = createServerClient(Astro.cookies);

// Verificar autenticación y rol admin
const { data: { session } } = await supabase.auth.getSession();
if (!session) return Astro.redirect('/auth/login');

const { data: userData } = await supabase
  .from('users').select('role').eq('id', session.user.id).single();
if (!userData || userData.role !== 'admin') return Astro.redirect('/');

// Obtener suscriptores
const { data: subscribers, count } = await supabase
  .from('newsletters')
  .select('*', { count: 'exact' })
  .order('created_at', { ascending: false })
  .limit(50);
---

<AdminLayout title="Newsletter" currentPage="newsletter">
  
  <!-- Estadísticas -->
  <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
    <div class="bg-white rounded-xl shadow-sm p-5 border-l-4 border-purple-500">
      <p class="text-sm font-medium text-gray-500">Total Suscriptores</p>
      <p class="text-2xl font-bold text-gray-800 mt-1">{count || 0}</p>
    </div>
    <div class="bg-white rounded-xl shadow-sm p-5 border-l-4 border-green-500">
      <p class="text-sm font-medium text-gray-500">Este Mes</p>
      <p class="text-2xl font-bold text-gray-800 mt-1" id="this-month">-</p>
    </div>
    <div class="bg-white rounded-xl shadow-sm p-5 border-l-4 border-blue-500">
      <p class="text-sm font-medium text-gray-500">Última Semana</p>
      <p class="text-2xl font-bold text-gray-800 mt-1" id="this-week">-</p>
    </div>
  </div>

  <!-- Acciones -->
  <div class="bg-white rounded-xl shadow-sm p-6 mb-6">
    <div class="flex flex-wrap gap-4 items-center justify-between">
      <div>
        <h2 class="text-lg font-semibold text-gray-800">Gestión de Newsletter</h2>
        <p class="text-sm text-gray-500 mt-1">Exporta la lista de suscriptores o envía campañas</p>
      </div>
      <div class="flex gap-3">
        <button id="export-btn" class="px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 transition-colors font-medium">
          Exportar CSV
        </button>
        <button id="send-campaign-btn" class="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition-colors font-medium">
          Nueva Campaña
        </button>
      </div>
    </div>
  </div>

  <!-- Lista de Suscriptores -->
  <div class="bg-white rounded-xl shadow-sm overflow-hidden">
    <div class="px-6 py-4 border-b border-gray-200">
      <h3 class="font-semibold text-gray-800">Últimos Suscriptores</h3>
    </div>
    
    {subscribers && subscribers.length > 0 ? (
      <div class="overflow-x-auto">
        <table class="w-full">
          <thead class="bg-gray-50">
            <tr>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Email</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Fecha Suscripción</th>
              <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase">Acciones</th>
            </tr>
          </thead>
          <tbody class="divide-y divide-gray-100">
            {subscribers.map((sub: any) => (
              <tr class="hover:bg-gray-50">
                <td class="px-6 py-4">
                  <span class="font-medium text-gray-800">{sub.email}</span>
                </td>
                <td class="px-6 py-4 text-gray-500">
                  {new Date(sub.created_at).toLocaleDateString('es-ES', {
                    day: '2-digit',
                    month: 'short',
                    year: 'numeric'
                  })}
                </td>
                <td class="px-6 py-4 text-right">
                  <button 
                    class="delete-sub-btn text-red-600 hover:text-red-800 text-sm"
                    data-email={sub.email}
                  >
                    Eliminar
                  </button>
                </td>
              </tr>
            ))}
          </tbody>
        </table>
      </div>
    ) : (
      <div class="text-center py-12 text-gray-500">
        <svg class="w-12 h-12 mx-auto text-gray-300 mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/>
        </svg>
        <p>No hay suscriptores todavía</p>
      </div>
    )}
  </div>

  <script>
    import { supabase } from '../../lib/supabase';

    // Exportar CSV
    document.getElementById('export-btn')?.addEventListener('click', async () => {
      try {
        const { data } = await supabase
          .from('newsletters')
          .select('email, created_at')
          .order('created_at', { ascending: false });

        if (data && data.length > 0) {
          const csvEscape = (v: string) => `"${String(v).replace(/"/g, '""')}"`;          const csv = 'Email,Fecha\n' + data.map((s: any) => `${csvEscape(s.email)},${csvEscape(s.created_at)}`).join('\n');
          const blob = new Blob([csv], { type: 'text/csv' });
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = `newsletter-${new Date().toISOString().split('T')[0]}.csv`;
          a.click();
        } else {
          alert('No hay datos para exportar');
        }
      } catch (err) {
        console.error(err);
        alert('Error al exportar');
      }
    });

    // Nueva campaña (placeholder)
    document.getElementById('send-campaign-btn')?.addEventListener('click', () => {
      alert('Función de envío de campañas en desarrollo. Puedes exportar la lista y usar un servicio externo como Mailchimp.');
    });

    // Eliminar suscriptor
    document.querySelectorAll('.delete-sub-btn').forEach(btn => {
      btn.addEventListener('click', async () => {
        const email = (btn as HTMLButtonElement).dataset.email;
        if (!confirm(`¿Eliminar suscriptor ${email}?`)) return;

        try {
          const { error } = await supabase
            .from('newsletters')
            .delete()
            .eq('email', email);

          if (error) throw error;
          window.location.reload();
        } catch (err) {
          console.error(err);
          alert('Error al eliminar');
        }
      });
    });
  </script>
</AdminLayout>
