---
export const prerender = false;
import AdminLayout from '../../layouts/AdminLayout.astro';
import { createServerClient, supabaseAdmin } from '../../lib/supabase';

const supabase = await createServerClient(Astro.cookies);

// Verificar autenticación y rol admin
const { data: { session } } = await supabase.auth.getSession();
if (!session) return Astro.redirect('/auth/login');

const { data: userData } = await supabaseAdmin
  .from('users').select('role').eq('id', session.user.id).single();
if (!userData || userData.role !== 'admin') return Astro.redirect('/');

// Obtener suscriptores del newsletter
const { data: subscribers } = await supabaseAdmin
  .from('newsletters')
  .select('email, promo_code, created_at')
  .order('created_at', { ascending: false });

// Obtener clientes registrados (no admin)
const { data: registeredUsers } = await supabaseAdmin
  .from('users')
  .select('email, full_name, created_at')
  .neq('role', 'admin')
  .order('created_at', { ascending: false });

// Combinar y deduplicar por email
interface Contact {
  email: string;
  name: string;
  source: 'newsletter' | 'cliente' | 'ambos';
  promo_code: string;
  created_at: string;
}

const contactMap = new Map<string, Contact>();

// Primero los suscriptores del newsletter
(subscribers || []).forEach((sub: any) => {
  contactMap.set(sub.email, {
    email: sub.email,
    name: '',
    source: 'newsletter',
    promo_code: sub.promo_code || '',
    created_at: sub.created_at,
  });
});

// Luego los usuarios registrados (merge o crear)
(registeredUsers || []).forEach((u: any) => {
  const existing = contactMap.get(u.email);
  if (existing) {
    existing.source = 'ambos';
    existing.name = u.full_name || '';
  } else {
    contactMap.set(u.email, {
      email: u.email,
      name: u.full_name || '',
      source: 'cliente',
      promo_code: '',
      created_at: u.created_at,
    });
  }
});

const contacts: Contact[] = [...contactMap.values()];
contacts.sort((a, b) => new Date(b.created_at).getTime() - new Date(a.created_at).getTime());

const totalContacts = contacts.length;
const totalNewsletter = contacts.filter(c => c.source === 'newsletter' || c.source === 'ambos').length;
const totalClientes = contacts.filter(c => c.source === 'cliente' || c.source === 'ambos').length;

// Obtener codigos promo activos para el modal
const { data: promoCodes } = await supabaseAdmin
  .from('promo_codes')
  .select('code, discount_percentage, expires_at')
  .eq('active', true)
  .order('created_at', { ascending: false });
---

<AdminLayout title="Newsletter" currentPage="newsletter">

  <!-- Estadísticas -->
  <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
    <div class="bg-white rounded-xl shadow-sm p-5 border-l-4 border-purple-500">
      <p class="text-sm font-medium text-gray-500">Total Contactos</p>
      <p class="text-2xl font-bold text-gray-800 mt-1">{totalContacts}</p>
    </div>
    <div class="bg-white rounded-xl shadow-sm p-5 border-l-4 border-green-500">
      <p class="text-sm font-medium text-gray-500">Suscriptores Newsletter</p>
      <p class="text-2xl font-bold text-gray-800 mt-1">{totalNewsletter}</p>
    </div>
    <div class="bg-white rounded-xl shadow-sm p-5 border-l-4 border-blue-500">
      <p class="text-sm font-medium text-gray-500">Clientes Registrados</p>
      <p class="text-2xl font-bold text-gray-800 mt-1">{totalClientes}</p>
    </div>
  </div>

  <!-- Barra de seleccion -->
  <div id="selection-bar" class="hidden bg-purple-50 border border-purple-200 rounded-xl p-4 mb-6">
    <div class="flex items-center justify-between">
      <span class="text-purple-700 font-medium">
        <span id="selected-count">0</span> contactos seleccionados
      </span>
      <button id="open-campaign-modal" class="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition-colors font-medium">
        Enviar Campana
      </button>
    </div>
  </div>

  <!-- Acciones -->
  <div class="bg-white rounded-xl shadow-sm p-6 mb-6">
    <div class="flex flex-wrap gap-4 items-center justify-between">
      <div>
        <h2 class="text-lg font-semibold text-gray-800">Contactos</h2>
        <p class="text-sm text-gray-500 mt-1">Suscriptores del newsletter + clientes registrados. Selecciona y envia campanas.</p>
      </div>
      <div class="flex gap-3">
        <!-- Filtro por origen -->
        <select id="filter-source" class="px-3 py-2 border border-gray-200 rounded-lg text-sm focus:ring-2 focus:ring-purple-400">
          <option value="">Todos</option>
          <option value="newsletter">Solo Newsletter</option>
          <option value="cliente">Solo Clientes</option>
          <option value="ambos">Ambos</option>
        </select>
        <button id="export-btn" class="px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 transition-colors font-medium">
          Exportar CSV
        </button>
        <button id="send-campaign-btn" class="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition-colors font-medium">
          Nueva Campana
        </button>
      </div>
    </div>
  </div>

  <!-- Lista de Contactos -->
  <div class="bg-white rounded-xl shadow-sm overflow-hidden">
    <div class="px-6 py-4 border-b border-gray-200">
      <h3 class="font-semibold text-gray-800">Todos los contactos ({totalContacts})</h3>
    </div>

    {contacts.length > 0 ? (
      <div class="overflow-x-auto">
        <table class="w-full">
          <thead class="bg-gray-50">
            <tr>
              <th class="px-6 py-3 text-left">
                <input type="checkbox" id="select-all" class="rounded border-gray-300 text-purple-600 focus:ring-purple-500 cursor-pointer" />
              </th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Email</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Nombre</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Origen</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Fecha</th>
            </tr>
          </thead>
          <tbody class="divide-y divide-gray-100">
            {contacts.map((contact) => (
              <tr class="hover:bg-gray-50 contact-row" data-source={contact.source}>
                <td class="px-6 py-4">
                  <input
                    type="checkbox"
                    class="subscriber-checkbox rounded border-gray-300 text-purple-600 focus:ring-purple-500 cursor-pointer"
                    data-email={contact.email}
                  />
                </td>
                <td class="px-6 py-4">
                  <span class="font-medium text-gray-800">{contact.email}</span>
                </td>
                <td class="px-6 py-4 text-gray-600 text-sm">
                  {contact.name || '-'}
                </td>
                <td class="px-6 py-4">
                  {contact.source === 'newsletter' && (
                    <span class="px-2 py-1 text-xs font-medium bg-green-100 text-green-700 rounded-full">Newsletter</span>
                  )}
                  {contact.source === 'cliente' && (
                    <span class="px-2 py-1 text-xs font-medium bg-blue-100 text-blue-700 rounded-full">Cliente</span>
                  )}
                  {contact.source === 'ambos' && (
                    <span class="px-2 py-1 text-xs font-medium bg-purple-100 text-purple-700 rounded-full">Ambos</span>
                  )}
                </td>
                <td class="px-6 py-4 text-gray-500 text-sm">
                  {new Date(contact.created_at).toLocaleDateString('es-ES', {
                    day: '2-digit',
                    month: 'short',
                    year: 'numeric'
                  })}
                </td>
              </tr>
            ))}
          </tbody>
        </table>
      </div>
    ) : (
      <div class="text-center py-12 text-gray-500">
        <svg class="w-12 h-12 mx-auto text-gray-300 mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/>
        </svg>
        <p>No hay contactos todavia</p>
      </div>
    )}
  </div>

  <!-- Modal de Campana -->
  <div id="campaign-modal" class="hidden fixed inset-0 z-50 overflow-y-auto">
    <div class="fixed inset-0 bg-black/50" id="modal-backdrop"></div>
    <div class="relative min-h-screen flex items-center justify-center p-4">
      <div class="relative bg-white rounded-2xl shadow-xl max-w-lg w-full p-6">
        <button id="close-modal" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
          </svg>
        </button>

        <h2 class="text-xl font-bold text-gray-800 mb-1">Nueva Campana</h2>
        <p class="text-sm text-gray-500 mb-6">
          Enviar email con codigo promocional a <span id="modal-count" class="font-bold text-purple-600">0</span> contactos
        </p>

        <!-- Asunto -->
        <div class="mb-4">
          <label class="block text-sm font-medium text-gray-700 mb-1">Asunto del email</label>
          <input type="text" id="campaign-subject"
            value="Oferta exclusiva para ti"
            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-400 focus:border-transparent text-sm" />
        </div>

        <!-- Modo de codigo promo -->
        <div class="mb-4">
          <label class="block text-sm font-medium text-gray-700 mb-2">Codigo Promocional</label>
          <div class="flex gap-4 mb-3">
            <label class="flex items-center gap-2 cursor-pointer">
              <input type="radio" name="promo-mode" value="new" checked
                class="text-purple-600 focus:ring-purple-500" />
              <span class="text-sm">Generar nuevo</span>
            </label>
            <label class="flex items-center gap-2 cursor-pointer">
              <input type="radio" name="promo-mode" value="existing"
                class="text-purple-600 focus:ring-purple-500" />
              <span class="text-sm">Usar existente</span>
            </label>
          </div>

          <!-- Opciones: codigo nuevo -->
          <div id="new-code-section">
            <label class="block text-sm font-medium text-gray-700 mb-1">Porcentaje de descuento</label>
            <select id="discount-percentage"
              class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-400 focus:border-transparent text-sm">
              <option value="5">5%</option>
              <option value="10" selected>10%</option>
              <option value="15">15%</option>
              <option value="20">20%</option>
              <option value="25">25%</option>
              <option value="30">30%</option>
              <option value="50">50%</option>
            </select>
            <p class="text-xs text-gray-400 mt-1">Se generara un codigo tipo PROMOXXXXXX, valido 30 dias</p>
          </div>

          <!-- Opciones: codigo existente -->
          <div id="existing-code-section" class="hidden">
            <label class="block text-sm font-medium text-gray-700 mb-1">Seleccionar codigo</label>
            <select id="existing-promo-code"
              class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-400 focus:border-transparent text-sm">
              <option value="">Seleccionar...</option>
              {promoCodes?.map((pc: any) => (
                <option value={pc.code}>
                  {pc.code} ({pc.discount_percentage}%)
                </option>
              ))}
            </select>
          </div>
        </div>

        <!-- Botones -->
        <div class="flex gap-3 mt-6">
          <button id="cancel-campaign" class="flex-1 px-4 py-2.5 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors font-medium">
            Cancelar
          </button>
          <button id="confirm-campaign" class="flex-1 px-4 py-2.5 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition-colors font-medium">
            Enviar Campana
          </button>
        </div>

        <!-- Progreso / resultado -->
        <div id="campaign-progress" class="hidden mt-4 p-4 rounded-lg"></div>
      </div>
    </div>
  </div>

  <!-- Toast -->
  <div id="toast" class="hidden fixed bottom-4 right-4 px-6 py-3 rounded-lg shadow-lg z-50 text-white font-medium"></div>

  <script>
    import { supabase } from '../../lib/supabase';

    // --- Utilidades ---
    function showToast(message: string, type: 'success' | 'error' = 'success') {
      const toast = document.getElementById('toast')!;
      toast.textContent = message;
      toast.className = `fixed bottom-4 right-4 px-6 py-3 rounded-lg shadow-lg z-50 text-white font-medium ${
        type === 'success' ? 'bg-green-500' : 'bg-red-500'
      }`;
      setTimeout(() => toast.classList.add('hidden'), 4000);
    }

    // --- Filtro por origen ---
    const filterSource = document.getElementById('filter-source') as HTMLSelectElement;
    const contactRows = document.querySelectorAll('.contact-row') as NodeListOf<HTMLElement>;

    filterSource?.addEventListener('change', () => {
      const value = filterSource.value;
      contactRows.forEach(row => {
        const source = row.dataset.source || '';
        if (!value || source === value) {
          row.style.display = '';
        } else {
          row.style.display = 'none';
          // Desmarcar checkbox de filas ocultas
          const cb = row.querySelector('.subscriber-checkbox') as HTMLInputElement;
          if (cb) cb.checked = false;
        }
      });
      updateSelectionUI();
    });

    // --- Seleccion ---
    const selectAll = document.getElementById('select-all') as HTMLInputElement;
    const checkboxes = document.querySelectorAll('.subscriber-checkbox') as NodeListOf<HTMLInputElement>;
    const selectionBar = document.getElementById('selection-bar')!;
    const selectedCountEl = document.getElementById('selected-count')!;

    function getSelectedEmails(): string[] {
      const checked = document.querySelectorAll('.subscriber-checkbox:checked') as NodeListOf<HTMLInputElement>;
      return [...checked].map(cb => cb.dataset.email!);
    }

    function getVisibleCheckboxes(): HTMLInputElement[] {
      return [...checkboxes].filter(cb => {
        const row = cb.closest('.contact-row') as HTMLElement;
        return row && row.style.display !== 'none';
      });
    }

    function updateSelectionUI() {
      const count = getSelectedEmails().length;
      selectedCountEl.textContent = count.toString();
      selectionBar.classList.toggle('hidden', count === 0);
    }

    selectAll?.addEventListener('change', () => {
      // Solo afecta filas visibles
      getVisibleCheckboxes().forEach(cb => cb.checked = selectAll.checked);
      updateSelectionUI();
    });

    checkboxes.forEach(cb => {
      cb.addEventListener('change', () => {
        const visible = getVisibleCheckboxes();
        selectAll.checked = visible.length > 0 && visible.every(c => c.checked);
        updateSelectionUI();
      });
    });

    // --- Modal ---
    const modal = document.getElementById('campaign-modal')!;
    const modalCount = document.getElementById('modal-count')!;
    const progressDiv = document.getElementById('campaign-progress')!;

    function openModal() {
      const emails = getSelectedEmails();
      if (emails.length === 0) {
        showToast('Selecciona al menos un contacto', 'error');
        return;
      }
      modalCount.textContent = emails.length.toString();
      progressDiv.classList.add('hidden');
      progressDiv.innerHTML = '';
      (document.getElementById('confirm-campaign') as HTMLButtonElement).disabled = false;
      (document.getElementById('confirm-campaign') as HTMLButtonElement).textContent = 'Enviar Campana';
      modal.classList.remove('hidden');
    }

    function closeModal() {
      modal.classList.add('hidden');
    }

    document.getElementById('open-campaign-modal')?.addEventListener('click', openModal);

    document.getElementById('send-campaign-btn')?.addEventListener('click', () => {
      // Si no hay seleccion, seleccionar todos los visibles
      if (getSelectedEmails().length === 0) {
        selectAll.checked = true;
        getVisibleCheckboxes().forEach(cb => cb.checked = true);
        updateSelectionUI();
      }
      openModal();
    });

    document.getElementById('cancel-campaign')?.addEventListener('click', closeModal);
    document.getElementById('close-modal')?.addEventListener('click', closeModal);
    document.getElementById('modal-backdrop')?.addEventListener('click', closeModal);

    // Toggle modo promo
    document.querySelectorAll('input[name="promo-mode"]').forEach(radio => {
      radio.addEventListener('change', (e) => {
        const mode = (e.target as HTMLInputElement).value;
        document.getElementById('new-code-section')!.classList.toggle('hidden', mode !== 'new');
        document.getElementById('existing-code-section')!.classList.toggle('hidden', mode !== 'existing');
      });
    });

    // --- Enviar campana ---
    document.getElementById('confirm-campaign')?.addEventListener('click', async () => {
      const confirmBtn = document.getElementById('confirm-campaign') as HTMLButtonElement;
      const emails = getSelectedEmails();

      if (emails.length === 0) return;

      const mode = (document.querySelector('input[name="promo-mode"]:checked') as HTMLInputElement).value;
      const subject = (document.getElementById('campaign-subject') as HTMLInputElement).value.trim();

      const body: any = { emails, promoCodeMode: mode, subject: subject || undefined };

      if (mode === 'new') {
        body.discountPercentage = parseInt(
          (document.getElementById('discount-percentage') as HTMLSelectElement).value
        );
      } else {
        body.existingPromoCode = (document.getElementById('existing-promo-code') as HTMLSelectElement).value;
        if (!body.existingPromoCode) {
          showToast('Selecciona un codigo promocional', 'error');
          return;
        }
      }

      if (!confirm(`¿Enviar campana a ${emails.length} contacto${emails.length > 1 ? 's' : ''}?`)) return;

      confirmBtn.disabled = true;
      confirmBtn.textContent = 'Enviando...';
      progressDiv.classList.remove('hidden');
      progressDiv.className = 'mt-4 p-4 rounded-lg bg-blue-50';
      progressDiv.innerHTML = `<p class="text-sm text-blue-700 text-center">Enviando a ${emails.length} contactos...</p>`;

      try {
        const { data: { session } } = await supabase.auth.getSession();
        const res = await fetch('/api/admin/send-campaign', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${session?.access_token}`,
          },
          body: JSON.stringify(body),
        });

        const result = await res.json();

        if (res.ok) {
          progressDiv.className = 'mt-4 p-4 rounded-lg bg-green-50';
          progressDiv.innerHTML = `
            <p class="text-green-700 font-medium text-center">Campana enviada</p>
            <p class="text-green-600 text-xs text-center mt-1">
              Codigo: <span class="font-mono font-bold">${result.promoCode}</span> |
              Enviados: ${result.sent} | Fallidos: ${result.failed}
            </p>
          `;
          showToast(`Campana enviada a ${result.sent} contactos`);
        } else {
          progressDiv.className = 'mt-4 p-4 rounded-lg bg-red-50';
          progressDiv.innerHTML = `<p class="text-red-700 text-sm text-center">${result.error || 'Error al enviar'}</p>`;
          showToast(result.error || 'Error al enviar campana', 'error');
        }
      } catch (err) {
        progressDiv.className = 'mt-4 p-4 rounded-lg bg-red-50';
        progressDiv.innerHTML = `<p class="text-red-700 text-sm text-center">Error de conexion</p>`;
        showToast('Error de conexion', 'error');
      } finally {
        confirmBtn.disabled = false;
        confirmBtn.textContent = 'Enviar Campana';
      }
    });

    // --- Exportar CSV ---
    document.getElementById('export-btn')?.addEventListener('click', () => {
      const rows = document.querySelectorAll('.contact-row') as NodeListOf<HTMLElement>;
      const csvEscape = (v: string) => `"${String(v || '').replace(/"/g, '""')}"`;
      const csvRows = ['Email,Nombre,Origen,Fecha'];

      rows.forEach(row => {
        if (row.style.display === 'none') return;
        const cells = row.querySelectorAll('td');
        if (cells.length < 5) return;
        csvRows.push([
          csvEscape(cells[1]?.textContent?.trim() || ''),
          csvEscape(cells[2]?.textContent?.trim() || ''),
          csvEscape(cells[3]?.textContent?.trim() || ''),
          csvEscape(cells[4]?.textContent?.trim() || ''),
        ].join(','));
      });

      if (csvRows.length <= 1) {
        showToast('No hay datos para exportar', 'error');
        return;
      }

      const blob = new Blob([csvRows.join('\n')], { type: 'text/csv;charset=utf-8;' });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = `contactos-${new Date().toISOString().split('T')[0]}.csv`;
      a.click();
      URL.revokeObjectURL(a.href);
    });
  </script>
</AdminLayout>
