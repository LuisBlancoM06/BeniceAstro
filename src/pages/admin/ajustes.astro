---
import AdminLayout from '../../layouts/AdminLayout.astro';
import { createServerClient } from '../../lib/supabase';

const supabase = createServerClient(Astro.cookies);

// Verificar autenticación y rol admin
const { data: { session } } = await supabase.auth.getSession();
if (!session) return Astro.redirect('/auth/login');

const { data: userData } = await supabase
  .from('users').select('role').eq('id', session.user.id).single();
if (!userData || userData.role !== 'admin') return Astro.redirect('/');

// Obtener configuraciones actuales
const { data: settings } = await supabase
  .from('settings')
  .select('*');

const getSettingValue = (key: string, defaultValue: string = '') => {
  const setting = settings?.find((s: any) => s.key === key);
  return setting?.value || defaultValue;
};
---

<AdminLayout title="Ajustes" currentPage="ajustes">
  
  <div class="max-w-3xl">
    
    <!-- Información de la Tienda -->
    <div class="bg-white rounded-xl shadow-sm p-6 mb-6">
      <h2 class="text-lg font-semibold text-gray-800 mb-4">Información de la Tienda</h2>
      
      <form id="store-settings-form" class="space-y-4">
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Nombre de la Tienda</label>
          <input 
            type="text" 
            name="store_name" 
            value={getSettingValue('store_name', 'Benice Pet Shop')}
            class="w-full px-3 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-purple-400"
          />
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Email de Contacto</label>
          <input 
            type="email" 
            name="contact_email" 
            value={getSettingValue('contact_email', 'info@benice.es')}
            class="w-full px-3 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-purple-400"
          />
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Teléfono</label>
          <input 
            type="tel" 
            name="contact_phone" 
            value={getSettingValue('contact_phone', '')}
            class="w-full px-3 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-purple-400"
            placeholder="+34 600 000 000"
          />
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Dirección</label>
          <textarea 
            name="store_address" 
            rows="2"
            class="w-full px-3 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-purple-400"
            placeholder="Calle Principal 123, 28001 Madrid"
          >{getSettingValue('store_address', '')}</textarea>
        </div>
        
        <button type="submit" class="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition-colors font-medium">
          Guardar Cambios
        </button>
      </form>
    </div>

    <!-- Configuración de Envíos -->
    <div class="bg-white rounded-xl shadow-sm p-6 mb-6">
      <h2 class="text-lg font-semibold text-gray-800 mb-4">Configuración de Envíos</h2>
      
      <form id="shipping-settings-form" class="space-y-4">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Coste de Envío Estándar (€)</label>
            <input 
              type="number" 
              name="shipping_cost" 
              step="0.01"
              value={getSettingValue('shipping_cost', '4.99')}
              class="w-full px-3 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-purple-400"
            />
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Envío Gratis a partir de (€)</label>
            <input 
              type="number" 
              name="free_shipping_threshold" 
              step="0.01"
              value={getSettingValue('free_shipping_threshold', '49.00')}
              class="w-full px-3 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-purple-400"
            />
          </div>
        </div>
        
        <button type="submit" class="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition-colors font-medium">
          Guardar Cambios
        </button>
      </form>
    </div>

    <!-- Códigos Promocionales -->
    <div class="bg-white rounded-xl shadow-sm p-6 mb-6">
      <h2 class="text-lg font-semibold text-gray-800 mb-4">Códigos Promocionales</h2>
      
      <form id="promo-form" class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Código</label>
          <input 
            type="text" 
            name="code" 
            required
            class="w-full px-3 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-purple-400"
            placeholder="VERANO2026"
          />
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Descuento (%)</label>
          <input 
            type="number" 
            name="discount" 
            min="1"
            max="100"
            required
            class="w-full px-3 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-purple-400"
            placeholder="10"
          />
        </div>
        <div class="flex items-end">
          <button type="submit" class="w-full px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 transition-colors font-medium">
            Crear Código
          </button>
        </div>
      </form>

      <div id="promo-list" class="space-y-2">
        <!-- Los códigos se cargarán aquí -->
      </div>
    </div>

    <!-- Zona Peligrosa -->
    <div class="bg-red-50 border border-red-200 rounded-xl p-6">
      <h2 class="text-lg font-semibold text-red-800 mb-4">Zona Peligrosa</h2>
      <p class="text-sm text-red-600 mb-4">Estas acciones no se pueden deshacer. Procede con precaución.</p>
      
      <div class="flex gap-3">
        <button id="clear-cache-btn" class="px-4 py-2 bg-red-100 text-red-700 rounded-lg hover:bg-red-200 transition-colors font-medium">
          Limpiar Caché
        </button>
      </div>
    </div>
  </div>

  <script>
    import { supabase } from '../../lib/supabase';

    // Función para guardar setting
    async function saveSetting(key: string, value: string) {
      const { error } = await supabase
        .from('settings')
        .upsert({ key, value }, { onConflict: 'key' });
      
      if (error) throw error;
    }

    // Guardar configuración de tienda
    document.getElementById('store-settings-form')?.addEventListener('submit', async (e) => {
      e.preventDefault();
      const form = e.target as HTMLFormElement;
      const formData = new FormData(form);
      
      try {
        for (const [key, value] of formData.entries()) {
          await saveSetting(key, value as string);
        }
        alert('Configuración guardada');
      } catch (err) {
        console.error(err);
        alert('Error al guardar');
      }
    });

    // Guardar configuración de envíos
    document.getElementById('shipping-settings-form')?.addEventListener('submit', async (e) => {
      e.preventDefault();
      const form = e.target as HTMLFormElement;
      const formData = new FormData(form);
      
      try {
        for (const [key, value] of formData.entries()) {
          await saveSetting(key, value as string);
        }
        alert('Configuración de envíos guardada');
      } catch (err) {
        console.error(err);
        alert('Error al guardar');
      }
    });

    // Cargar códigos promocionales
    async function loadPromoCodes() {
      const { data } = await supabase
        .from('promo_codes')
        .select('*')
        .order('created_at', { ascending: false });

      const list = document.getElementById('promo-list');
      if (!list) return;

      if (data && data.length > 0) {
        list.innerHTML = data.map((code: any) => `
          <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
            <div>
              <span class="font-mono font-bold text-purple-700">${code.code}</span>
              <span class="text-gray-500 ml-2">${code.discount}% dto</span>
              ${code.active ? '<span class="ml-2 px-2 py-0.5 text-xs bg-green-100 text-green-800 rounded">Activo</span>' : '<span class="ml-2 px-2 py-0.5 text-xs bg-gray-100 text-gray-600 rounded">Inactivo</span>'}
            </div>
            <button class="delete-code-btn text-red-600 hover:text-red-800 text-sm" data-id="${code.id}">
              Eliminar
            </button>
          </div>
        `).join('');

        // Añadir event listeners para eliminar
        document.querySelectorAll('.delete-code-btn').forEach(btn => {
          btn.addEventListener('click', async () => {
            const id = (btn as HTMLButtonElement).dataset.id;
            if (!confirm('¿Eliminar este código?')) return;

            try {
              await supabase.from('promo_codes').delete().eq('id', id);
              loadPromoCodes();
            } catch (err) {
              alert('Error al eliminar');
            }
          });
        });
      } else {
        list.innerHTML = '<p class="text-gray-500 text-sm">No hay códigos promocionales</p>';
      }
    }

    loadPromoCodes();

    // Crear código promocional
    document.getElementById('promo-form')?.addEventListener('submit', async (e) => {
      e.preventDefault();
      const form = e.target as HTMLFormElement;
      const formData = new FormData(form);
      
      const code = (formData.get('code') as string).toUpperCase();
      const discount = parseInt(formData.get('discount') as string);

      try {
        const { error } = await supabase
          .from('promo_codes')
          .insert({ code, discount, active: true });

        if (error) throw error;
        form.reset();
        loadPromoCodes();
      } catch (err: any) {
        console.error(err);
        alert(err.message || 'Error al crear código');
      }
    });

    // Limpiar caché
    document.getElementById('clear-cache-btn')?.addEventListener('click', () => {
      if (confirm('¿Limpiar caché del navegador para esta página?')) {
        localStorage.clear();
        sessionStorage.clear();
        alert('Caché limpiado');
        window.location.reload();
      }
    });
  </script>
</AdminLayout>
