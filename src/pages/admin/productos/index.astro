---
export const prerender = false;
import AdminLayout from '../../../layouts/AdminLayout.astro';
import { createServerClient, supabaseAdmin } from '../../../lib/supabase';

const supabase = await createServerClient(Astro.cookies);

// Verificar autenticación y rol admin
const { data: { session } } = await supabase.auth.getSession();
if (!session) return Astro.redirect('/auth/login');

const { data: userData } = await supabaseAdmin
  .from('users').select('role').eq('id', session.user.id).single();
if (!userData || userData.role !== 'admin') return Astro.redirect('/');

// Obtener productos
const { data: products } = await supabaseAdmin
  .from('products')
  .select('*')
  .order('created_at', { ascending: false });
---

<AdminLayout title="Productos" currentPage="productos">
  <!-- Filtros rápidos -->
    <div class="bg-white rounded-lg shadow p-4 mb-6">
      <div class="flex flex-wrap gap-4 items-center">
        <div>
          <label class="text-sm font-medium text-gray-700">Buscar:</label>
          <input type="text" id="search-filter" placeholder="Nombre del producto..." 
            class="ml-2 input w-64" />
        </div>
        <div>
          <label class="text-sm font-medium text-gray-700">Categoría:</label>
          <select id="category-filter" class="ml-2 input">
            <option value="">Todas</option>
            <option value="alimentacion">Alimentación</option>
            <option value="higiene">Higiene</option>
            <option value="salud">Salud</option>
            <option value="accesorios">Accesorios</option>
            <option value="juguetes">Juguetes</option>
          </select>
        </div>
        <div>
          <label class="text-sm font-medium text-gray-700">Especie:</label>
          <select id="animal-filter" class="ml-2 input">
            <option value="">Todas</option>
            <option value="perro">Perro</option>
            <option value="gato">Gato</option>
            <option value="otros">Otros</option>
          </select>
        </div>
        <div class="ml-auto">
          <span class="text-sm text-gray-600">
            Total: <strong id="product-count">{products?.length || 0}</strong> productos
          </span>
        </div>
      </div>
    </div>

    <!-- Tabla de productos -->
    <div class="bg-white rounded-lg shadow overflow-hidden">
      <table class="min-w-full divide-y divide-gray-200">
        <thead class="bg-gray-50">
          <tr>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
              Producto
            </th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
              Categoría
            </th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
              Precio
            </th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
              Stock
            </th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
              Estado
            </th>
            <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">
              Acciones
            </th>
          </tr>
        </thead>
        <tbody id="products-table" class="bg-white divide-y divide-gray-200">
          {products && products.map((product: any) => (
            <tr class="product-row hover:bg-gray-50" 
                data-name={product.name.toLowerCase()} 
                data-category={product.category}
                data-animal={product.animal_type}>
              <td class="px-6 py-4 whitespace-nowrap">
                <div class="flex items-center">
                  <div class="flex-shrink-0 h-12 w-12">
                    {product.image_url ? (
                      <img class="h-12 w-12 rounded-lg object-cover" 
                           src={product.image_url} 
                           alt={product.name} />
                    ) : (
                      <div class="h-12 w-12 rounded-lg bg-gradient-to-br from-purple-400 to-pink-500 flex items-center justify-center">
                        <span class="text-white text-[8px] font-bold">Sin img</span>
                      </div>
                    )}
                  </div>
                  <div class="ml-4">
                    <div class="text-sm font-medium text-gray-900">{product.name}</div>
                    <div class="text-sm text-gray-500">{product.animal_type} • {product.size}</div>
                  </div>
                </div>
              </td>
              <td class="px-6 py-4 whitespace-nowrap">
                <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-blue-100 text-blue-800">
                  {product.category}
                </span>
              </td>
              <td class="px-6 py-4 whitespace-nowrap">
                <div class="text-sm text-gray-900 font-medium">{product.price}€</div>
                {product.on_sale && product.sale_price && (
                  <div class="text-xs text-green-600">Oferta: {product.sale_price}€</div>
                )}
              </td>
              <td class="px-6 py-4 whitespace-nowrap">
                <span class={`px-2 py-1 text-xs font-medium rounded ${
                  product.stock > 10 ? 'bg-green-100 text-green-800' : 
                  product.stock > 0 ? 'bg-yellow-100 text-yellow-800' : 
                  'bg-red-100 text-red-800'
                }`}>
                  {product.stock} uds
                </span>
              </td>
              <td class="px-6 py-4 whitespace-nowrap">
                {product.on_sale ? (
                  <span class="px-2 py-1 text-xs font-medium rounded bg-orange-100 text-orange-800">
                    Oferta
                  </span>
                ) : (
                  <span class="px-2 py-1 text-xs font-medium rounded bg-gray-100 text-gray-600">
                    Normal
                  </span>
                )}
              </td>
              <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                <a href={`/admin/productos/${product.id}`} 
                   class="text-purple-700 hover:text-purple-900 mr-4">
                  Editar
                </a>
                <button class="text-red-600 hover:text-red-900 delete-btn" 
                        data-id={product.id} 
                        data-name={product.name}>
                  Eliminar
                </button>
              </td>
            </tr>
          ))}
        </tbody>
      </table>
      
      {(!products || products.length === 0) && (
        <div class="text-center py-12">
          <p class="text-gray-500 text-lg">No hay productos registrados</p>
          <a href="/admin/productos/nuevo" class="btn btn-primary mt-4">
            Crear primer producto
          </a>
        </div>
      )}
    </div>

  <!-- Modal de confirmación de eliminación -->
  <div id="delete-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
    <div class="bg-white rounded-lg max-w-md w-full p-6">
      <h3 class="text-xl font-bold text-gray-800 mb-4">Confirmar Eliminación</h3>
      <p class="text-gray-600 mb-2">¿Estás seguro de que quieres eliminar el producto:</p>
      <p class="font-bold text-gray-800 mb-4" id="delete-product-name"></p>
      <p class="text-sm text-red-600 mb-6">Esta acción no se puede deshacer.</p>
      <div class="flex gap-3 justify-end">
        <button id="cancel-delete" class="btn bg-gray-200 text-gray-700 hover:bg-gray-300">
          Cancelar
        </button>
        <button id="confirm-delete" class="btn bg-red-600 text-white hover:bg-red-700">
          Eliminar
        </button>
      </div>
    </div>
  </div>

  <script>
    import { supabase } from '../../../lib/supabase';

    // Filtros
    const searchFilter = document.getElementById('search-filter') as HTMLInputElement;
    const categoryFilter = document.getElementById('category-filter') as HTMLSelectElement;
    const animalFilter = document.getElementById('animal-filter') as HTMLSelectElement;
    const productCount = document.getElementById('product-count');
    const rows = document.querySelectorAll('.product-row');

    function filterProducts() {
      const search = searchFilter.value.toLowerCase();
      const category = categoryFilter.value;
      const animal = animalFilter.value;
      let visible = 0;

      rows.forEach(row => {
        const name = row.getAttribute('data-name') || '';
        const rowCategory = row.getAttribute('data-category') || '';
        const rowAnimal = row.getAttribute('data-animal') || '';

        const matchSearch = name.includes(search);
        const matchCategory = !category || rowCategory === category;
        const matchAnimal = !animal || rowAnimal === animal;

        if (matchSearch && matchCategory && matchAnimal) {
          (row as HTMLElement).style.display = '';
          visible++;
        } else {
          (row as HTMLElement).style.display = 'none';
        }
      });

      if (productCount) productCount.textContent = visible.toString();
    }

    searchFilter?.addEventListener('input', filterProducts);
    categoryFilter?.addEventListener('change', filterProducts);
    animalFilter?.addEventListener('change', filterProducts);

    // Modal de eliminación
    const deleteModal = document.getElementById('delete-modal');
    const deleteProductName = document.getElementById('delete-product-name');
    const cancelDelete = document.getElementById('cancel-delete');
    const confirmDelete = document.getElementById('confirm-delete');
    let productToDelete: string | null = null;

    document.querySelectorAll('.delete-btn').forEach(btn => {
      btn.addEventListener('click', (e) => {
        const target = e.currentTarget as HTMLElement;
        productToDelete = target.dataset.id || null;
        const name = target.dataset.name || '';
        
        if (deleteProductName) deleteProductName.textContent = name;
        deleteModal?.classList.remove('hidden');
      });
    });

    cancelDelete?.addEventListener('click', () => {
      deleteModal?.classList.add('hidden');
      productToDelete = null;
    });

    confirmDelete?.addEventListener('click', async () => {
      if (!productToDelete) return;

      try {
        const { data: { session } } = await supabase.auth.getSession();
        
        if (!session?.access_token) {
          throw new Error('No hay sesión activa');
        }
        
        console.log(`[FRONTEND] Intentando eliminar producto ID: ${productToDelete}`);
        
        const response = await fetch(`/api/admin/products?id=${productToDelete}`, {
          method: 'DELETE',
          headers: {
            'Authorization': `Bearer ${session.access_token}`,
            'Content-Type': 'application/json'
          }
        });

        console.log(`[FRONTEND] Response status: ${response.status}`);

        if (response.ok) {
          // Recargar página para ver cambios
          window.location.reload();
        } else {
          let errorMessage = 'Error al eliminar producto';
          
          try {
            const result = await response.json();
            console.error('[FRONTEND] Error response:', result);
            
            if (result.error) {
              errorMessage = result.error;
            }
            
            // Mostrar error detallado solo en desarrollo
            if (result.details && window.location.hostname === 'localhost') {
              errorMessage += `\n\nDetalles: ${JSON.stringify(result.details, null, 2)}`;
            }
          } catch (parseError) {
            console.error('[FRONTEND] Error parsing JSON:', parseError);
            const responseText = await response.text();
            console.error('[FRONTEND] Raw response:', responseText);
            
            if (responseText.includes('CSRF blocked')) {
              errorMessage = 'Error de seguridad: CSRF bloqueado. Recarga la página e intenta nuevamente.';
            } else if (responseText.includes('Cross-site')) {
              errorMessage = 'Error de origen: Recarga la página e intenta nuevamente.';
            } else {
              errorMessage = `Error del servidor (${response.status}): ${responseText.substring(0, 100)}`;
            }
          }
          
          alert(errorMessage);
        }
      } catch (error) {
        console.error('[FRONTEND] Error general:', error);
        const errorMessage = error instanceof Error ? error.message : 'Error desconocido';
        alert(`Error al eliminar producto: ${errorMessage}`);
      }

      deleteModal?.classList.add('hidden');
      productToDelete = null;
    });
  </script>
</AdminLayout>
