---
export const prerender = false;
import Layout from '../../layouts/Layout.astro';
import AddressAutocomplete from '../../components/AddressAutocomplete.tsx';
import { createServerClient } from '../../lib/supabase';

const supabase = await createServerClient(Astro.cookies);
const { data: { session } } = await supabase.auth.getSession();

if (!session) {
  return Astro.redirect('/auth/login');
}

const { data: user } = await supabase
  .from('users')
  .select('*')
  .eq('id', session.user.id)
  .single();

// Obtener estadísticas del usuario (solo pedidos completados)
const validStatuses = ['pagado', 'enviado', 'entregado'];

const { count: totalOrders } = await supabase
  .from('orders')
  .select('*', { count: 'exact', head: true })
  .eq('user_id', session.user.id)
  .in('status', validStatuses);

const { data: totalSpentData } = await supabase
  .from('orders')
  .select('total')
  .eq('user_id', session.user.id)
  .in('status', validStatuses);

const totalSpent = totalSpentData?.reduce((sum: number, order: any) => sum + Number(order.total), 0) || 0;
---

<Layout title="Mi Perfil">
  <div class="min-h-screen bg-gray-50 py-8">
    <div class="max-w-4xl mx-auto px-4">
      
      <!-- Header con avatar -->
      <div class="bg-white rounded-2xl shadow-sm p-8 mb-6">
        <div class="flex items-center gap-6">
          <div class="w-24 h-24 bg-purple-100 rounded-full flex items-center justify-center">
            <svg class="w-12 h-12 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg>
          </div>
          <div class="flex-1">
            <h1 class="text-3xl font-bold text-gray-800">{user?.full_name || 'Usuario'}</h1>
            <p class="text-gray-600">{session.user.email}</p>
            <p class="text-sm text-gray-500 mt-1">Miembro desde {new Date(user?.created_at || session.user?.user_metadata?.created_at || Date.now()).toLocaleDateString('es-ES', { 
              day: 'numeric', 
              month: 'long', 
              year: 'numeric' 
            })}</p>
          </div>
          <div class="hidden md:flex gap-8">
            <div class="text-center">
              <p class="text-3xl font-bold text-purple-600">{totalOrders || 0}</p>
              <p class="text-sm text-gray-500">Pedidos</p>
            </div>
            <div class="text-center">
              <p class="text-3xl font-bold text-green-600">{totalSpent.toFixed(0)}€</p>
              <p class="text-sm text-gray-500">Total gastado</p>
            </div>
          </div>
        </div>
      </div>

      <div class="grid md:grid-cols-2 gap-6">
        <!-- Información Personal -->
        <div class="bg-white rounded-2xl shadow-sm p-6">
          <h2 class="text-xl font-bold mb-6 flex items-center gap-2">
            <svg class="w-5 h-5 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg> Información Personal
          </h2>
          
          <form id="profile-form" class="space-y-4">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Nombre Completo</label>
              <input
                type="text"
                id="full-name"
                value={user?.full_name || ''}
                class="w-full px-4 py-3 rounded-lg border border-gray-200 focus:ring-2 focus:ring-purple-500 focus:border-purple-500"
                placeholder="Tu nombre"
              />
            </div>

            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Email</label>
              <input
                type="email"
                value={session.user.email}
                disabled
                class="w-full px-4 py-3 rounded-lg border border-gray-200 bg-gray-50 text-gray-500"
              />
            </div>

            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Teléfono</label>
              <input
                type="tel"
                id="phone"
                value={user?.phone || ''}
                class="w-full px-4 py-3 rounded-lg border border-gray-200 focus:ring-2 focus:ring-purple-500 focus:border-purple-500"
                placeholder="+34 600 000 000"
              />
            </div>

            <div>
              <AddressAutocomplete
                client:load
                id="address"
                label="Dirección de envío"
                sublabel={null}
                labelClassName="block text-sm font-medium text-gray-700 mb-1"
                placeholder="Busca tu dirección para autocompletar..."
                className=""
                fieldIds={{
                  line1: 'prof-line1',
                  line2: 'prof-line2',
                  city: 'prof-city',
                  state: 'prof-state',
                  postalCode: 'prof-postal',
                  country: 'prof-country',
                  lat: 'prof-lat',
                  lng: 'prof-lng',
                }}
              />
              <!-- Campos estructurados editables -->
              <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 mt-3">
                <div>
                  <label class="block text-xs font-medium text-gray-500 mb-1">Calle y número</label>
                  <input type="text" id="prof-line1" value={user?.address_line1 || ''} class="w-full px-3 py-2 text-sm rounded-lg border border-gray-200 focus:ring-2 focus:ring-purple-500" placeholder="Calle, 123" />
                </div>
                <div>
                  <label class="block text-xs font-medium text-gray-500 mb-1">Piso / Puerta</label>
                  <input type="text" id="prof-line2" value={user?.address_line2 || ''} class="w-full px-3 py-2 text-sm rounded-lg border border-gray-200 focus:ring-2 focus:ring-purple-500" placeholder="2ºA" />
                </div>
                <div>
                  <label class="block text-xs font-medium text-gray-500 mb-1">Ciudad</label>
                  <input type="text" id="prof-city" value={user?.city || ''} class="w-full px-3 py-2 text-sm rounded-lg border border-gray-200 focus:ring-2 focus:ring-purple-500" placeholder="Madrid" />
                </div>
                <div>
                  <label class="block text-xs font-medium text-gray-500 mb-1">Provincia</label>
                  <input type="text" id="prof-state" value={user?.state || ''} class="w-full px-3 py-2 text-sm rounded-lg border border-gray-200 focus:ring-2 focus:ring-purple-500" placeholder="Madrid" />
                </div>
                <div>
                  <label class="block text-xs font-medium text-gray-500 mb-1">Código postal</label>
                  <input type="text" id="prof-postal" value={user?.postal_code || ''} class="w-full px-3 py-2 text-sm rounded-lg border border-gray-200 focus:ring-2 focus:ring-purple-500" placeholder="28001" />
                </div>
                <div>
                  <label class="block text-xs font-medium text-gray-500 mb-1">País</label>
                  <select id="prof-country" class="w-full px-3 py-2 text-sm rounded-lg border border-gray-200 focus:ring-2 focus:ring-purple-500">
                    <option value="ES" selected>España</option>
                  </select>
                </div>
              </div>
              <input type="hidden" id="prof-lat" value={user?.latitude || ''} />
              <input type="hidden" id="prof-lng" value={user?.longitude || ''} />
            </div>

            <div id="profile-message" class="hidden p-3 rounded-lg text-sm"></div>

            <button type="submit" class="w-full py-3 bg-purple-600 text-white font-bold rounded-lg hover:bg-purple-700 transition-colors">
              Guardar Cambios
            </button>
          </form>
        </div>

        <!-- Seguridad -->
        <div class="space-y-6">
          <!-- Cambiar Contraseña -->
          <div class="bg-white rounded-2xl shadow-sm p-6">
            <h2 class="text-xl font-bold mb-6 flex items-center gap-2">
              <svg class="w-5 h-5 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path></svg> Cambiar Contraseña
            </h2>
            
            <form id="password-form" class="space-y-4">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Nueva Contraseña</label>
                <input
                  type="password"
                  id="new-password"
                  minlength="8"
                  class="w-full px-4 py-3 rounded-lg border border-gray-200 focus:ring-2 focus:ring-purple-500 focus:border-purple-500"
                  placeholder="Mínimo 8 caracteres"
                />
              </div>

              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Confirmar Contraseña</label>
                <input
                  type="password"
                  id="confirm-password"
                  class="w-full px-4 py-3 rounded-lg border border-gray-200 focus:ring-2 focus:ring-purple-500 focus:border-purple-500"
                  placeholder="Repite la contraseña"
                />
              </div>

              <div id="password-message" class="hidden p-3 rounded-lg text-sm"></div>

              <button type="submit" class="w-full py-3 bg-orange-500 text-white font-bold rounded-lg hover:bg-orange-600 transition-colors">
                Actualizar Contraseña
              </button>
            </form>
          </div>

          <!-- Accesos Rápidos -->
          <div class="bg-white rounded-2xl shadow-sm p-6">
            <h2 class="text-xl font-bold mb-4 flex items-center gap-2">
              <svg class="w-5 h-5 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg> Accesos Rápidos
            </h2>
            <div class="space-y-2">
              <a href="/admin" class="flex items-center gap-3 p-3 rounded-lg hover:bg-purple-50 transition-colors border border-purple-200 bg-purple-50/50">
                <svg class="w-8 h-8 text-purple-700" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.066 2.573c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.573 1.066c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.066-2.573c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                <div>
                  <p class="font-bold text-purple-700">Panel Admin</p>
                  <p class="text-sm text-purple-500">Gestionar tienda, pedidos y productos</p>
                </div>
              </a>
              <a href="/cuenta/mis-pedidos" class="flex items-center gap-3 p-3 rounded-lg hover:bg-gray-50 transition-colors">
                <svg class="w-8 h-8 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"></path></svg>
                <div>
                  <p class="font-medium">Mis Pedidos</p>
                  <p class="text-sm text-gray-500">Ver historial de compras</p>
                </div>
              </a>
              <a href="/cuenta/favoritos" class="flex items-center gap-3 p-3 rounded-lg hover:bg-gray-50 transition-colors">
                <svg class="w-8 h-8 text-red-500" fill="currentColor" viewBox="0 0 24 24"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/></svg>
                <div>
                  <p class="font-medium">Favoritos</p>
                  <p class="text-sm text-gray-500">Productos guardados</p>
                </div>
              </a>
              <button id="logout-btn" class="w-full flex items-center gap-3 p-3 rounded-lg hover:bg-red-50 text-red-600 transition-colors">
                <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path></svg>
                <div class="text-left">
                  <p class="font-medium">Cerrar Sesión</p>
                  <p class="text-sm text-red-400">Salir de tu cuenta</p>
                </div>
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    import { supabase } from '../../lib/supabase';

    // Actualizar perfil
    const profileForm = document.getElementById('profile-form');
    const profileMessage = document.getElementById('profile-message');

    profileForm?.addEventListener('submit', async (e) => {
      e.preventDefault();

      const fullName = (document.getElementById('full-name') as HTMLInputElement).value;
      const phone = (document.getElementById('phone') as HTMLInputElement).value;
      const address = (document.getElementById('address') as HTMLInputElement)?.value || '';

      // Campos estructurados
      const address_line1 = (document.getElementById('prof-line1') as HTMLInputElement)?.value || '';
      const address_line2 = (document.getElementById('prof-line2') as HTMLInputElement)?.value || '';
      const city = (document.getElementById('prof-city') as HTMLInputElement)?.value || '';
      const state = (document.getElementById('prof-state') as HTMLInputElement)?.value || '';
      const postal_code = (document.getElementById('prof-postal') as HTMLInputElement)?.value || '';
      const country = (document.getElementById('prof-country') as HTMLSelectElement)?.value || 'ES';
      const latitude = parseFloat((document.getElementById('prof-lat') as HTMLInputElement)?.value) || null;
      const longitude = parseFloat((document.getElementById('prof-lng') as HTMLInputElement)?.value) || null;
      
      const { data: { session } } = await supabase.auth.getSession();

      try {
        // Usar endpoint API para actualizar perfil + sincronizar a Stripe
        const res = await fetch('/api/profile', {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${session!.access_token}`,
          },
          body: JSON.stringify({
            full_name: fullName,
            phone,
            address: address || `${address_line1}, ${city}, ${postal_code}`,
            address_line1,
            address_line2,
            city,
            state,
            postal_code,
            country,
            latitude,
            longitude,
          }),
        });

        if (!res.ok) {
          const data = await res.json();
          throw new Error(data.error || 'Error al actualizar');
        }

        profileMessage!.textContent = 'Perfil actualizado correctamente. Recargando...';
        profileMessage!.className = 'p-3 rounded-lg text-sm bg-green-100 text-green-700';
        profileMessage!.classList.remove('hidden');

        // Recargar la página para reflejar los cambios en la cabecera
        setTimeout(() => window.location.reload(), 1000);
      } catch (error: any) {
        profileMessage!.textContent = (error.message || 'Error al actualizar');
        profileMessage!.className = 'p-3 rounded-lg text-sm bg-red-100 text-red-700';
        profileMessage!.classList.remove('hidden');
      }
    });

    // Cambiar contraseña
    const passwordForm = document.getElementById('password-form');
    const passwordMessage = document.getElementById('password-message');

    passwordForm?.addEventListener('submit', async (e) => {
      e.preventDefault();

      const newPassword = (document.getElementById('new-password') as HTMLInputElement).value;
      const confirmPassword = (document.getElementById('confirm-password') as HTMLInputElement).value;

      if (newPassword.length < 8) {
        passwordMessage!.textContent = 'La contraseña debe tener al menos 8 caracteres';
        passwordMessage!.className = 'p-3 rounded-lg text-sm bg-red-100 text-red-700';
        passwordMessage!.classList.remove('hidden');
        return;
      }

      if (newPassword !== confirmPassword) {
        passwordMessage!.textContent = 'Las contraseñas no coinciden';
        passwordMessage!.className = 'p-3 rounded-lg text-sm bg-red-100 text-red-700';
        passwordMessage!.classList.remove('hidden');
        return;
      }

      try {
        const { error } = await supabase.auth.updateUser({ password: newPassword });

        if (error) throw error;

        passwordMessage!.textContent = 'Contraseña actualizada correctamente';
        passwordMessage!.className = 'p-3 rounded-lg text-sm bg-green-100 text-green-700';
        passwordMessage!.classList.remove('hidden');

        (document.getElementById('new-password') as HTMLInputElement).value = '';
        (document.getElementById('confirm-password') as HTMLInputElement).value = '';

        setTimeout(() => passwordMessage!.classList.add('hidden'), 3000);
      } catch (error: any) {
        passwordMessage!.textContent = (error.message || 'Error al actualizar');
        passwordMessage!.className = 'p-3 rounded-lg text-sm bg-red-100 text-red-700';
        passwordMessage!.classList.remove('hidden');
      }
    });

    // Cerrar sesión
    document.getElementById('logout-btn')?.addEventListener('click', async () => {
      await supabase.auth.signOut();
      // Borrar cookies HttpOnly vía endpoint servidor
      try {
        await fetch('/api/auth/session', { method: 'DELETE' });
      } catch (e) {
        // Fallback: intentar borrar directamente (no funciona con HttpOnly pero no daña)
        document.cookie = 'sb-access-token=; path=/; max-age=0';
        document.cookie = 'sb-refresh-token=; path=/; max-age=0';
      }
      window.location.href = '/';
    });
  </script>
</Layout>

