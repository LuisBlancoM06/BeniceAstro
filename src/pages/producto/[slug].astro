---
import Layout from '../../layouts/Layout.astro';
import { supabase } from '../../lib/supabase';
import ProductReviews from '../../components/ProductReviews';

// Obtener el slug o id del producto
const { slug } = Astro.params;

if (!slug) {
  return Astro.redirect('/productos');
}

// Buscar producto por slug o por id
let product = null;

// Primero intentar por slug
const { data: productBySlug } = await supabase
  .from('products')
  .select('*')
  .eq('slug', slug)
  .single();

if (productBySlug) {
  product = productBySlug;
} else {
  // Si no existe por slug, intentar por id
  const { data: productById } = await supabase
    .from('products')
    .select('*')
    .eq('id', slug)
    .single();
  product = productById;
}

if (!product) {
  return Astro.redirect('/productos');
}

// Obtener productos relacionados (misma categoría y especie)
const { data: relatedProducts } = await supabase
  .from('products')
  .select('*')
  .eq('animal_type', product.animal_type)
  .eq('category', product.category)
  .neq('id', product.id)
  .limit(4);

// Calcular precio a mostrar
const displayPrice = product.on_sale && product.sale_price ? product.sale_price : product.price;
const hasDiscount = product.on_sale && product.sale_price && product.sale_price < product.price;
const discountPercent = hasDiscount 
  ? Math.round((1 - product.sale_price / product.price) * 100) 
  : 0;

// Obtener estadísticas de reseñas reales
const { data: reviewStats } = await supabase.rpc('get_product_review_stats', {
  p_product_id: product.id,
});
const avgRating = reviewStats?.avg_rating || 0;
const totalReviews = reviewStats?.total_reviews || 0;
const fullStars = Math.floor(avgRating);
const hasHalf = avgRating - fullStars >= 0.3;
const emptyStars = 5 - fullStars - (hasHalf ? 1 : 0);

// Generar HTML de estrellas para evitar problemas con key en SVGs de Astro
const starFull = '<svg class="w-5 h-5 text-yellow-400 fill-current" viewBox="0 0 20 20"><path d="M10 15l-5.878 3.09 1.123-6.545L.489 6.91l6.572-.955L10 0l2.939 5.955 6.572.955-4.756 4.635 1.123 6.545z"/></svg>';
const starHalf = '<svg class="w-5 h-5" viewBox="0 0 20 20"><defs><linearGradient id="half-star"><stop offset="50%" stop-color="#facc15"/><stop offset="50%" stop-color="#d1d5db"/></linearGradient></defs><path fill="url(#half-star)" d="M10 15l-5.878 3.09 1.123-6.545L.489 6.91l6.572-.955L10 0l2.939 5.955 6.572.955-4.756 4.635 1.123 6.545z"/></svg>';
const starEmpty = '<svg class="w-5 h-5 text-gray-300 fill-current" viewBox="0 0 20 20"><path d="M10 15l-5.878 3.09 1.123-6.545L.489 6.91l6.572-.955L10 0l2.939 5.955 6.572.955-4.756 4.635 1.123 6.545z"/></svg>';

let starsHtml = '';
if (avgRating > 0) {
  starsHtml = starFull.repeat(fullStars) + (hasHalf ? starHalf : '') + starEmpty.repeat(emptyStars);
} else {
  starsHtml = starEmpty.repeat(5);
}

// Detección de imágenes placeholder
function isPlaceholder(url: string | null | undefined): boolean {
  if (!url) return true;
  return url.includes('placehold.co') || url.includes('via.placeholder') || url.includes('placeholder');
}

// Usar imagen local basada en slug
const localImageUrl = `/images/productos/${product.slug}.jpg`;
const mainIsPlaceholder = false; // Siempre usar imagen local

// Gradientes por especie/categoría
function getCategoryGradient(animal: string, category: string): string {
  const gradients: Record<string, Record<string, string>> = {
    perro: {
      alimentacion: 'from-orange-400 to-amber-600',
      higiene: 'from-blue-400 to-cyan-500',
      salud: 'from-green-400 to-emerald-600',
      accesorios: 'from-purple-400 to-indigo-600',
      juguetes: 'from-pink-400 to-rose-500',
    },
    gato: {
      alimentacion: 'from-emerald-400 to-teal-600',
      higiene: 'from-sky-400 to-blue-500',
      salud: 'from-lime-400 to-green-600',
      accesorios: 'from-violet-400 to-purple-600',
      juguetes: 'from-fuchsia-400 to-pink-500',
    },
    otros: {
      alimentacion: 'from-yellow-400 to-orange-500',
      higiene: 'from-teal-400 to-cyan-600',
      salud: 'from-emerald-400 to-green-500',
      accesorios: 'from-indigo-400 to-blue-600',
      juguetes: 'from-rose-400 to-red-500',
    },
  };
  return gradients[animal]?.[category] || 'from-purple-400 to-pink-500';
}

const mainGradient = getCategoryGradient(product.animal_type || 'otros', product.category || 'alimentacion');

// SVG icons por especie
function getAnimalSvg(animal: string): string {
  if (animal === 'perro') {
    return '<svg class="w-24 h-24 text-white/30" fill="currentColor" viewBox="0 0 24 24"><path d="M18 4c-.55 0-1.05.22-1.41.59L12 9.17 7.41 4.59C7.05 4.22 6.55 4 6 4c-1.1 0-2 .9-2 2v4c0 1.1.45 2.1 1.17 2.83L9 16.66V20c0 .55.45 1 1 1h4c.55 0 1-.45 1-1v-3.34l3.83-3.83C19.55 12.1 20 11.1 20 10V6c0-1.1-.9-2-2-2z"/></svg>';
  }
  if (animal === 'gato') {
    return '<svg class="w-24 h-24 text-white/30" fill="currentColor" viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 15h-2v-2h2v2zm0-4h-2V7h2v6zm4 4h-2v-2h2v2zm0-4h-2V7h2v6z"/></svg>';
  }
  return '<svg class="w-24 h-24 text-white/30" fill="currentColor" viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/></svg>';
}
---

<Layout title={`${product.name} - Venice`}>
  <div class="bg-white min-h-screen">
    <div class="max-w-7xl mx-auto px-4 py-8">
      
      <!-- Breadcrumb -->
      <nav class="text-sm mb-6">
        <ol class="flex items-center space-x-2 text-gray-500">
          <li><a href="/" class="hover:text-purple-700">Inicio</a></li>
          <li><span class="mx-2">›</span></li>
          <li><a href="/productos" class="hover:text-purple-700">Productos</a></li>
          <li><span class="mx-2">›</span></li>
          <li class="text-gray-800 font-medium truncate max-w-xs">{product.name}</li>
        </ol>
      </nav>

      <!-- Producto Principal -->
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-12 mb-16">
        
        <!-- Galería de Imágenes -->
        <div class="space-y-4">
          <!-- Imagen Principal -->
          <div class="relative aspect-square rounded-2xl overflow-hidden">
            {hasDiscount && (
              <div class="absolute top-4 left-4 z-10">
                <span class="bg-red-500 text-white text-sm font-bold px-3 py-1 rounded-full">
                  -{discountPercent}%
                </span>
              </div>
            )}
            {mainIsPlaceholder ? (
              <div class={`w-full h-full bg-gradient-to-br ${mainGradient} flex flex-col items-center justify-center p-8`}>
                <Fragment set:html={getAnimalSvg(product.animal_type || 'otros')} />
                <p class="mt-4 text-white/80 font-bold text-xl text-center">{product.brand || product.name}</p>
                <p class="mt-1 text-white/60 text-sm text-center">{product.name}</p>
              </div>
            ) : (
              <div class="w-full h-full bg-gray-100">
                <img 
                  id="main-image"
                  src={localImageUrl} 
                  alt={product.name}
                  class="w-full h-full object-contain p-8 transition-transform hover:scale-105"
                  onerror="this.parentElement.innerHTML='<div class=\'w-full h-full bg-gradient-to-br from-purple-400 to-pink-500 flex items-center justify-center\'><span class=\'text-white/80 font-bold text-xl text-center px-4\'>' + this.alt + '</span></div>'"
                />
              </div>
            )}
          </div>
          
          <!-- Thumbnails (si hay múltiples imágenes) -->
          {product.images && product.images.length > 1 && (
            <div class="flex gap-3 overflow-x-auto pb-2">
              {product.images.map((img: string, index: number) => (
                <button 
                  class="thumbnail flex-shrink-0 w-20 h-20 rounded-lg border-2 border-gray-200 overflow-hidden hover:border-purple-500 transition-colors"
                  data-image={img}
                >
                  <img src={img} alt={`${product.name} - ${index + 1}`} class="w-full h-full object-cover" />
                </button>
              ))}
            </div>
          )}
        </div>

        <!-- Información del Producto -->
        <div class="space-y-6">
          <!-- Nombre -->
          <h1 class="text-3xl font-bold text-gray-900">{product.name}</h1>

          <!-- Valoración -->
          <a href="#valoraciones" class="flex items-center gap-2 group">
            <div class="flex"><Fragment set:html={starsHtml} /></div>
            <span class="text-gray-600 group-hover:text-purple-700 transition-colors">
              {avgRating > 0 ? `(${avgRating}) • ${totalReviews} valoraciones` : 'Sin valoraciones aún'}
            </span>
          </a>

          <!-- Precio -->
          <div class="space-y-1">
            {hasDiscount ? (
              <div class="flex items-baseline gap-3">
                <span class="text-4xl font-bold text-red-600">{displayPrice}€</span>
                <span class="text-xl text-gray-400 line-through">{product.price}€</span>
                <span class="text-sm font-medium text-red-600 bg-red-100 px-2 py-1 rounded">
                  Ahorras {(product.price - product.sale_price).toFixed(2)}€
                </span>
              </div>
            ) : (
              <span class="text-4xl font-bold text-gray-900">{product.price}€</span>
            )}
            <p class="text-sm text-gray-500">IVA incluido</p>
          </div>

          <!-- Stock -->
          <div class="flex items-center gap-2">
            {product.stock > 10 ? (
              <span class="flex items-center text-green-600 font-medium">
                <svg class="w-5 h-5 mr-1" fill="currentColor" viewBox="0 0 20 20">
                  <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
                </svg>
                En stock ({product.stock} disponibles)
              </span>
            ) : product.stock > 0 ? (
              <span class="flex items-center text-orange-600 font-medium">
                <svg class="w-5 h-5 mr-1" fill="currentColor" viewBox="0 0 20 20">
                  <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"/>
                </svg>
                ¡Últimas unidades! ({product.stock})
              </span>
            ) : (
              <span class="flex items-center text-red-600 font-medium">
                <svg class="w-5 h-5 mr-1" fill="currentColor" viewBox="0 0 20 20">
                  <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"/>
                </svg>
                Agotado
              </span>
            )}
          </div>

          <!-- Cantidad y Añadir al Carrito -->
          <div class="border-t border-b py-6 space-y-4">
            <div class="flex items-center gap-4">
              <label class="font-medium text-gray-700">Cantidad:</label>
              <div class="flex items-center border rounded-lg">
                <button id="decrease-qty" class="px-4 py-2 text-gray-600 hover:bg-gray-100 transition-colors">
                  −
                </button>
                <input 
                  type="number" 
                  id="quantity" 
                  value="1" 
                  min="1" 
                  max={product.stock}
                  class="w-16 text-center border-x py-2 focus:outline-none"
                />
                <button id="increase-qty" class="px-4 py-2 text-gray-600 hover:bg-gray-100 transition-colors">
                  +
                </button>
              </div>
            </div>

            <button 
              id="add-to-cart-btn"
              class={`w-full py-4 rounded-xl font-bold text-lg transition-all ${
                product.stock > 0 
                  ? 'bg-orange-500 text-white hover:bg-orange-600 hover:shadow-lg' 
                  : 'bg-gray-300 text-gray-500 cursor-not-allowed'
              }`}
              disabled={product.stock === 0}
              data-product-id={product.id}
              data-product-name={product.name}
              data-product-price={product.price}
              data-product-sale-price={hasDiscount ? product.sale_price : ''}
              data-product-image={localImageUrl}
              data-product-stock={product.stock}
            >
              {product.stock > 0 ? 'Añadir al Carrito' : 'Sin Stock'}
            </button>

            <p class="text-center text-sm text-gray-500">
              Envío gratis en pedidos superiores a 49€
            </p>
          </div>

          <!-- Descripción -->
          <div class="space-y-3">
            <h2 class="text-lg font-semibold text-gray-800">Descripción</h2>
            <p class="text-gray-600 leading-relaxed">
              {product.description || 'Sin descripción disponible.'}
            </p>
          </div>

          <!-- Características -->
          <div class="bg-gray-50 rounded-xl p-6 space-y-3">
            <h2 class="text-lg font-semibold text-gray-800">Características</h2>
            <ul class="space-y-2 text-gray-600">
              <li class="flex items-center gap-2">
                <svg class="w-5 h-5 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>
                <strong>Especie:</strong> {product.animal_type === 'perro' ? 'Perro' : product.animal_type === 'gato' ? 'Gato' : 'Otros animales'}
              </li>
              <li class="flex items-center gap-2">
                <svg class="w-5 h-5 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>
                <strong>Tamaño:</strong> {product.size === 'mini' ? 'Mini/Toy' : product.size === 'mediano' ? 'Mediano' : 'Grande'}
              </li>
              <li class="flex items-center gap-2">
                <svg class="w-5 h-5 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>
                <strong>Etapa de vida:</strong> {product.age_range === 'cachorro' ? 'Cachorro' : product.age_range === 'adulto' ? 'Adulto' : 'Senior'}
              </li>
              <li class="flex items-center gap-2">
                <svg class="w-5 h-5 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>
                <strong>Categoría:</strong> {product.category}
              </li>
            </ul>
          </div>
        </div>
      </div>

      <!-- Sección de Valoraciones (componente React interactivo) -->
      <ProductReviews client:load productId={product.id} productName={product.name} />

      <!-- Productos Relacionados -->
      {relatedProducts && relatedProducts.length > 0 && (
        <div class="border-t pt-12">
          <h2 class="text-2xl font-bold text-gray-800 mb-6">Productos Relacionados</h2>
          <div class="grid grid-cols-2 md:grid-cols-4 gap-6">
            {relatedProducts.map((related: any) => (
              <a href={`/producto/${related.slug || related.id}`} class="group">
                <div class="bg-white border rounded-xl overflow-hidden hover:shadow-lg transition-shadow">
                  <div class="aspect-square p-4">
                    {
                      <img 
                        src={`/images/productos/${related.slug}.jpg`} 
                        alt={related.name}
                        class="w-full h-full object-contain group-hover:scale-105 transition-transform"
                        onerror="this.style.display='none';this.parentElement.innerHTML='<div class=\'w-full h-full rounded-lg bg-gradient-to-br from-purple-400 to-pink-500 flex items-center justify-center\'><span class=\'text-white/80 font-semibold text-xs text-center px-2\'>' + this.alt + '</span></div>'"
                      />
                    }
                  </div>
                  <div class="p-4">
                    <h3 class="font-medium text-gray-800 line-clamp-2 mb-2">{related.name}</h3>
                    <p class="text-lg font-bold text-orange-500">
                      {related.on_sale && related.sale_price ? related.sale_price : related.price}€
                    </p>
                  </div>
                </div>
              </a>
            ))}
          </div>
        </div>
      )}
    </div>
  </div>

  <!-- Toast de confirmación -->
  <div id="toast" class="hidden fixed bottom-4 right-4 bg-green-600 text-white px-6 py-3 rounded-lg shadow-lg z-50 flex items-center gap-2">
    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
      <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
    </svg>
    <span>Producto añadido al carrito</span>
  </div>

  <script>
    // Cambiar imagen principal al clicar thumbnail
    document.querySelectorAll('.thumbnail').forEach(thumb => {
      thumb.addEventListener('click', () => {
        const mainImage = document.getElementById('main-image') as HTMLImageElement;
        const newSrc = (thumb as HTMLElement).dataset.image;
        if (newSrc && mainImage) {
          mainImage.src = newSrc;
        }
      });
    });

    // Control de cantidad
    const quantityInput = document.getElementById('quantity') as HTMLInputElement;
    const decreaseBtn = document.getElementById('decrease-qty');
    const increaseBtn = document.getElementById('increase-qty');
    const maxStock = parseInt(quantityInput?.max || '99');

    decreaseBtn?.addEventListener('click', () => {
      const current = parseInt(quantityInput.value);
      if (current > 1) {
        quantityInput.value = (current - 1).toString();
      }
    });

    increaseBtn?.addEventListener('click', () => {
      const current = parseInt(quantityInput.value);
      if (current < maxStock) {
        quantityInput.value = (current + 1).toString();
      }
    });

    // Añadir al carrito usando el store de nanostores
    import { addToCart } from '../../stores/cart';

    const addToCartBtn = document.getElementById('add-to-cart-btn');
    const toast = document.getElementById('toast');

    addToCartBtn?.addEventListener('click', () => {
      const btn = addToCartBtn as HTMLButtonElement;
      const productId = btn.dataset.productId;
      const productName = btn.dataset.productName;
      const productPrice = parseFloat(btn.dataset.productPrice || '0');
      const productSalePrice = btn.dataset.productSalePrice ? parseFloat(btn.dataset.productSalePrice) : undefined;
      const productImage = btn.dataset.productImage;
      const quantity = parseInt(quantityInput.value);

      if (!productId || !productName) return;

      // Usar la función addToCart del store (guarda en localStorage con formato correcto y abre el carrito)
      addToCart({
        id: productId,
        name: productName,
        price: productPrice,
        salePrice: productSalePrice,
        image: productImage || '',
      }, quantity);

      // Mostrar toast
      toast?.classList.remove('hidden');
      setTimeout(() => {
        toast?.classList.add('hidden');
      }, 3000);
    });
  </script>
</Layout>
